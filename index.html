<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V87.3</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #refresh-dialog, #import-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        .pause-box { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .pause-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; }
        .btn-sub.active { background: var(--success) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.7rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; gap: 4px; }
        .month-header .m-stats { font-size: 0.58rem; color: #94a3b8; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .month-header.open::after { content: '‚ñ≤'; font-size: 0.5rem; margin-left: 3px; }
        .month-header:not(.open)::after { content: '‚ñº'; font-size: 0.5rem; margin-left: 3px; }
        .month-details-bar { background: #1a222f; color: #cbd5e0; padding: 12px 15px; font-size: 0.68rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; border-bottom: 2px solid #2d3748; }
        .detail-row { display: flex; justify-content: space-between; padding: 3px 6px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 2px solid transparent; }
        .row-nazu { border-left-color: #38bdf8; }
        .row-fae { border-left-color: #fbbf24; }
        .row-sazu { border-left-color: #818cf8; }
        .row-brgb { border-left-color: #f87171; }
        .row-sozu { border-left-color: #4ade80; }
        .row-fezu { border-left-color: #f472b6; }
        .row-4uhr { border-left-color: #2dd4bf; }
        .val-h { color: #38bdf8; font-weight: 500; }
        .val-eur { color: #4ade80; font-weight: 800; font-family: monospace; }
        .val-count { color: #fbbf24; font-weight: 800; }
        .spesen-bar { background: #111827; color: #4ade80; padding: 10px 15px; font-size: 0.75rem; border-bottom: 1px solid #4a5568; font-weight: bold; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; background: white; }
        tr:nth-child(even) { background: #f8fafc; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.75rem; vertical-align: middle; }
        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-mini { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 35px; height: 35px; }
        .btn-edit { background: var(--p); }
        .btn-del { background: var(--danger); }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; }
        .btn-close-edit { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #e2e8f0; color: #64748b; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .header-info-row { font-size: 0.7rem; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); line-height: 1.4; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="toast" class="toast">Aktion erfolgreich!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Status 2026</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist-Jahr</small><br><strong id="h_sum">0.00</strong> <small>h</small></div>
        <div><small>Saldo Aktuell</small><br><strong id="d_sum">0.00</strong> <small>h</small></div>
        <div style="text-align:right"><small>Soll Restjahr</small><br><strong id="s_offen">0.00</strong> <small>h</small></div>
    </div>
    <div class="header-info-row">
        <div id="vac-summary">Urlaub: 0 / 36</div>
        <div id="extra-vac-summary" style="color: #93c5fd;">Zusatzurlaub: 0 Tage (0.00/96.00h)</div>
    </div>
    <div class="progress-bar"><div id="p_fill" class="progress-fill"></div></div>
    <div style="font-size: 0.6rem; margin-top: 5px; opacity: 0.8; text-align: center;" id="p_text">Berechne 2026...</div>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Tarif-Einstellungen</h2>
    <div class="grid"><div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div><div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div></div>
    <div class="grid"><div><label>Samstag ‚Ç¨/h</label><input type="number" id="cfg-samstag" step="0.01"></div><div><label>Sonntag ‚Ç¨/h</label><input type="number" id="cfg-sonntag" step="0.01"></div></div>
    <div class="grid"><div><label>Feiertag ‚Ç¨/h</label><input type="number" id="cfg-feiertag" step="0.01"></div><div><label>4 Uhr Bonus ‚Ç¨</label><input type="number" id="cfg-bonus" step="0.01"></div></div>
    <div class="grid"><div><label>FAE ‚Ç¨/Tag</label><input type="number" id="cfg-fahrt" step="0.01"></div><div><label>Urlaub h/Tag</label><input type="number" id="cfg-gutschrift" step="0.01"></div></div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datenverwaltung</label>
        <button onclick="exportData()" style="background:#475569; margin-top:0; font-size:0.9rem;">üì• BACKUP KOPIEREN</button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">üì§ IMPORT</button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN & SCHLIE·∫ûEN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Daten Importieren</h2>
    <p style="font-size: 0.8rem; color: #64748b;">Gleichzeitiges Erg√§nzen und Sichern.</p>
    <textarea id="import-area" style="width:100%; height:300px; font-family:monospace; font-size:0.7rem; margin-bottom:15px;" placeholder='{"data":[...]}'></textarea>
    <button onclick="processImport()" style="background:var(--success)">DATEN VERARBEITEN</button>
    <button onclick="toggleImport()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="refresh-dialog" onclick="if(event.target===this) closeRefreshDialog()">
    <div class="dialog-content">
        <h3 style="margin-top:0">Tarif-Update</h3>
        <p style="font-size: 0.8rem; color: #64748b;">Ab welchem Datum neu berechnen?</p>
        <input type="date" id="refresh-date" style="margin-bottom:15px;">
        <button onclick="recalculateFromDate()" style="background:var(--success)">NEU BERECHNEN</button>
        <button onclick="closeRefreshDialog()" style="background:#64748b; margin-top:8px;">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <div id="btn-cancel-edit" class="btn-close-edit" onclick="cancelEdit()">√ó</div>
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum</label><input type="date" id="d" onchange="autoDetectDay()"></div><div><label>Typ</label><div id="type-display" style="padding:12px; background:#f1f5f9; border-radius:10px; text-align:center; font-weight:bold; font-size:0.8rem;">WERKTAG</div></div></div>
    <div class="grid"><div><label>Beginn</label><input type="time" id="s"></div><div><label>Ende</label><input type="time" id="e"></div></div>
    <div class="grid">
        <div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div>
        <div style="display:flex; align-items:center; justify-content:center; padding-top:15px;">
            <label style="display:flex; align-items:center; gap:8px; cursor: pointer; font-size:0.8rem;"><input type="checkbox" id="tr" checked style="width:20px; height:20px;"> FAE</label>
        </div>
    </div>
    <button id="main-btn" onclick="add()">Speichern</button>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <button id="btn-urlaub" class="btn-sub" onclick="toggleStatus('urlaub')">Urlaub</button>
        <button id="btn-krank" class="btn-sub" onclick="toggleStatus('krank')">Krank</button>
        <button id="btn-ruhe" class="btn-sub" onclick="toggleStatus('ruhe')">Ruhe</button>
    </div>
</div>

<div id="history"></div>

<script>
    const holidays = ["2026-01-01", "2026-03-08", "2026-04-03", "2026-04-06", "2026-05-01", "2026-05-14", "2026-05-25", "2026-10-03", "2026-12-25", "2026-12-26"];
    const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    const wDaysShort = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
    
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d && r.d.startsWith('2026'));
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let activeStatus = 'dienst';

    function showToast(txt) { const t=document.getElementById('toast'); t.innerText=txt; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }
    async function exportData() {
        const str = JSON.stringify({ data, config, date: new Date().toLocaleString() });
        try { await navigator.clipboard.writeText(str); showToast("Backup kopiert!"); } catch (err) { alert("Fehler"); }
    }
    function toggleImport() { document.getElementById('import-panel').style.display = (document.getElementById('import-panel').style.display === 'block' ? 'none' : 'block'); }
    
    function processImport() {
        const area = document.getElementById('import-area');
        // RADIKALE REINIGUNG DES TEXTES:
        // Entfernt unsichtbare HTML-Codes, krumme Anf√ºhrungszeichen und Zeilenumbr√ºche
        let raw = area.value.trim()
            .replace(/[\u201C\u201D\u201E\u201F]/g, '"') // Krumme Quotes zu geraden
            .replace(/[^\x20-\x7E\x0A\x0D]/g, ""); // Nur druckbare ASCII Zeichen
        
        try {
            const p = JSON.parse(raw);
            const newList = p.data || (Array.isArray(p) ? p : null);
            if(newList) {
                // MERGE LOGIK: Bestehende Tage behalten, neue hinzuf√ºgen (oder √ºberschreiben bei gleichem Datum)
                newList.forEach(newItem => {
                    data = data.filter(old => old.d !== newItem.d);
                    data.push(newItem);
                });
                localStorage.setItem('shifts_p10', JSON.stringify(data));
                render(); toggleImport(); area.value = '';
                alert("Daten erfolgreich hinzugef√ºgt!");
            }
        } catch(e) { alert("Formatfehler! Bitte stelle sicher, dass du alles von { bis } kopiert hast."); }
    }

    function timeToDec(t) { if(!t) return null; let [h,m]=t.split(':').map(Number); return h + m/60; }
    function openRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'flex'; }
    function closeRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'none'; }
    function recalculateFromDate() {
        const startD = document.getElementById('refresh-date').value; if(!startD) return;
        data = data.map(r => r.d >= startD ? calculateShift(r) : r);
        localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); closeRefreshDialog();
    }
    function toggleConfig() { document.getElementById('config-panel').style.display = (document.getElementById('config-panel').style.display === 'block' ? 'none' : 'block'); }
    function saveConfig() { localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render(); }
    function autoDetectDay() {
        const dStr = document.getElementById('d').value; if(!dStr) return;
        const dt = new Date(dStr); let l = 'üè¢ WERKTAG';
        if(holidays.includes(dStr)) l='üö© FEIERTAG'; else if(dt.getDay()===0) l='‚òÄÔ∏è SONNTAG'; else if(dt.getDay()===6) l='üìÖ SAMSTAG';
        document.getElementById('type-display').innerText = l;
    }
    function toggleStatus(st) { activeStatus = activeStatus === st ? 'dienst' : st; ['urlaub','krank','ruhe'].forEach(b => document.getElementById('btn-'+b).classList.toggle('active', activeStatus === b)); }

    function calculateShift(r) {
        if(['dienst','krank'].includes(r.status)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e); if(t1===null || t2===null) return r;
            if(t2<=t1) t2+=24;
            let n=0, sz=0, so=0, ft=0, w=0;
            for(let i=t1; i<t2; i+=0.25) {
                w+=0.25; let c=i%24, dt=new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                let isF=holidays.includes(dt.toISOString().split('T')[0]), isO=dt.getDay()===0, isA=dt.getDay()===6;
                if(c>=20 || c<6) n+=0.25; if(isF) ft+=0.25; else if(isO) so+=0.25; else if(isA && c>=13 && c<20) sz+=0.25;
            }
            r.h=w; r.nH=n; r.szH=sz; r.soH=so; r.ftH=ft;
            r.bonus=(r.status!=='krank' && ((t1%24>=0 && t1%24<4) || (t2%24>0 && t2%24<=4))) ? config.bonus : 0;
            let abw = (t2-t1); if(r.loc==='BHF') abw-=(7/60);
            r.spesen = r.status==='krank'?0:(Math.max(0, abw)>=8 ? (abw>=24?config.v3:(abw>=14?config.v2:config.v1)) : 0);
            r.fae = r.tr ? config.fahrt : 0; r.faeCount = r.tr ? 1 : 0;
        } else if(r.status==='urlaub') { r.h=config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        else { r.h=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        return r;
    }

    function add() {
        const d=document.getElementById('d').value; if(!d) return;
        const id=document.getElementById('edit-id').value;
        let r={ d, status:activeStatus, id:id?parseInt(id):Date.now(), s:document.getElementById('s').value, e:document.getElementById('e').value, loc:document.getElementById('loc').value, tr:document.getElementById('tr').checked };
        r=calculateShift(r); if(id) data=data.filter(x=>x.id!==parseInt(id)); data.push(r); localStorage.setItem('shifts_p10', JSON.stringify(data)); cancelEdit(); render();
    }
    function del(id) { if(confirm('L√∂schen?')) { data=data.filter(r=>r.id!==id); localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); } }

    function render() {
        const cont = document.getElementById('history'); cont.innerHTML = '';
        let now=new Date(), tH=0, tV=0, tN=0; const g={};
        data.forEach(r => {
            const m=r.d.substring(0,7); tH+=r.h; 
            if(r.status==='urlaub' && new Date(r.d).getDay()%6!==0 && !holidays.includes(r.d)) tV++; 
            tN+=r.nH; if(!g[m]) g[m]={items:[], h:0, nH:0, szH:0, soH:0, ftH:0, bE:0, sp:0, fE:0, fC:0, br:0};
            let mG=g[m]; mG.items.push(r); mG.h+=r.h; mG.nH+=r.nH; mG.szH+=r.szH; mG.soH+=r.soH; mG.ftH+=r.ftH; mG.bE+=r.bonus; mG.sp+=r.spesen; mG.fE+=r.fae; mG.fC+=(r.faeCount||0); if(r.loc==='BRGB') mG.br++;
        });
        const nSollH = (config.gutschrift * 60) / 5;
        document.getElementById('h_sum').innerText=tH.toFixed(2);
        document.getElementById('vac-summary').innerText=`Urlaub: ${tV}/${config.janspruch}`;
        document.getElementById('extra-vac-summary').innerText=`Zusatz: ${Math.floor(tN/nSollH)} Tage`;
        document.getElementById('p_fill').style.width=Math.min(100,(tH/config.jsoll*100))+"%";
        Object.keys(g).sort().reverse().forEach(m => {
            const mG=g[m], open=openMonths.has(m), [y, mo]=m.split('-'), nE=mG.nH*config.nacht, szE=mG.szH*config.samstag, soE=mG.soH*config.sonntag, ftE=mG.ftH*config.feiertag;
            cont.innerHTML += `<div class="year-group">
                <div class="month-header ${open?'open':''}" onclick="toggleM('${m}')">
                    <span>${monthNames[parseInt(mo)-1]} ${y} <b>(${mG.h.toFixed(1)}h)</b></span>
                </div>
                <div class="month-content ${open?'open':''}">
                    <table>${mG.items.sort((a,b)=>new Date(b.d)-new Date(a.d)).map(r => `<tr><td><b>${r.d.split('-').reverse().slice(0,2).join('.')}</b><br><small>${r.status}</small></td><td>${r.s||'--'}-${r.e||'--'}<br><small>${r.h.toFixed(1)}h</small></td><td class="action-btns"><button class="btn-mini btn-edit" onclick="edit(${r.id})">‚úé</button><button class="btn-mini btn-del" onclick="del(${r.id})">üóë</button></td></tr>`).join('')}</table>
                </div>
            </div>`;
        });
    }
    function toggleM(m) { openMonths.has(m)?openMonths.delete(m):openMonths.add(m); render(); }
    function edit(id) { 
        const r=data.find(x=>x.id===id); if(!r) return;
        document.getElementById('edit-id').value=r.id; document.getElementById('d').value=r.d; document.getElementById('s').value=r.s||''; document.getElementById('e').value=r.e||''; document.getElementById('loc').value=r.loc||'BHF'; document.getElementById('tr').checked=!!r.tr; 
        document.getElementById('edit-id-view').style.display='block'; document.getElementById('btn-cancel-edit').style.display='flex'; toggleStatus(r.status); window.scrollTo(0,0); 
    }
    function cancelEdit() { document.getElementById('edit-id').value=''; document.getElementById('edit-id-view').style.display='none'; document.getElementById('btn-cancel-edit').style.display='none'; ['s','e'].forEach(i=>document.getElementById(i).value=''); activeStatus='dienst'; toggleStatus('dienst'); }
    document.getElementById('d').value=new Date().toISOString().split('T')[0]; render();
</script>
</body>
</html>
