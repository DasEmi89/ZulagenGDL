<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84</title>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #refresh-dialog, #import-panel, #info-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        .pause-box { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .pause-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; }
        .btn-sub.active { background: var(--success) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; gap: 4px; }
        .month-header .m-stats { font-size: 0.75rem; color: #94a3b8; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .month-header.open::after { content: '‚ñ≤'; font-size: 0.5rem; margin-left: 3px; }
        .month-header:not(.open)::after { content: '‚ñº'; font-size: 0.5rem; margin-left: 3px; }
        .month-details-bar { background: #1a222f; color: #cbd5e0; padding: 12px 15px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; border-bottom: 2px solid #2d3748; }
        .detail-row { display: flex; justify-content: space-between; padding: 4px 6px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 2px solid transparent; }
        .row-nazu { border-left-color: #38bdf8; }
        .row-fae { border-left-color: #fbbf24; }
        .row-sazu { border-left-color: #818cf8; }
        .row-brgb { border-left-color: #f87171; }
        .row-sozu { border-left-color: #4ade80; }
        .row-fezu { border-left-color: #f472b6; }
        .row-4uhr { border-left-color: #2dd4bf; }
        .val-h { color: #38bdf8; font-weight: 500; }
        .val-eur { color: #4ade80; font-weight: 800; font-family: monospace; }
        .val-count { color: #fbbf24; font-weight: 800; }
        .spesen-bar { background: #111827; color: #4ade80; padding: 10px 15px; font-size: 0.9rem; border-bottom: 1px solid #4a5568; font-weight: bold; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; background: white; }
        tr:nth-child(even) { background: #f8fafc; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-mini { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 35px; height: 35px; }
        .btn-edit { background: var(--p); }
        .btn-del { background: var(--danger); }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; }
        .btn-close-edit { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #e2e8f0; color: #64748b; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .header-info-row { font-size: 0.8rem; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); line-height: 1.4; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .year-header { background: #0f172a; color: #38bdf8; font-weight: 800; border-bottom: 2px solid #38bdf8; }
        .version-footer { text-align: center; font-size: 0.65rem; color: #94a3b8; margin-top: 40px; padding-bottom: 20px; line-height: 1.5; }
        .info-item { border-bottom: 1px solid #f1f5f9; padding: 10px 0; display: flex; justify-content: space-between; font-size: 0.85rem; }
        .info-item b { color: var(--p); }
        .highlight-edit { animation: pulse-bg 2s infinite; }
        @keyframes pulse-bg { 0% { background-color: transparent; } 50% { background-color: rgba(37, 99, 235, 0.1); } 100% { background-color: transparent; } }
        .sync-indicator { font-size: 0.65rem; margin-top: 4px; opacity: 0.8; }
    </style>
</head>
<body>

<div id="toast" class="toast">In Zwischenablage kopiert!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="toggleInfo()">‚ÑπÔ∏è</span>
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Status 2026</h3>
    <div id="sync-info" class="sync-indicator">Kalender: Initialisiere...</div>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist (bis heute)</small><br><strong id="h_sum">0.00</strong> <small>h</small></div>
        <div><small>Saldo Aktuell</small><br><strong id="d_sum">0.00</strong> <small>h</small></div>
        <div style="text-align:right"><small>Soll Restjahr</small><br><strong id="s_offen">0.00</strong> <small>h</small></div>
    </div>
    <div class="header-info-row">
        <div id="vac-summary">Urlaub: 0 / 36</div>
        <div id="extra-vac-summary" style="color: #93c5fd;">Zusatzurlaub: 0 Tage (0.00/96.00h)</div>
    </div>
    <div class="progress-bar"><div id="p_fill" class="progress-fill"></div></div>
    <div style="font-size: 0.6rem; margin-top: 5px; opacity: 0.8; text-align: center;" id="p_text">Berechne 2026...</div>
</div>

<div id="info-panel">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0">Berechnungs-Regeln</h2>
        <span onclick="toggleInfo()" style="font-size: 1.5rem; cursor: pointer;">√ó</span>
    </div>
    <div id="info-content">
        <div class="info-item"><span>Nacht-Zeitraum:</span><b>20:00 - 06:00</b></div>
        <div class="info-item"><span>Samstag-Zulage:</span><b>13:00 - 20:00</b></div>
        <div class="info-item"><span>Priorit√§t:</span><b>Feiertag > Sa/So</b></div>
        <div class="info-item"><span>Nacht-Rundung:</span><b>Kaufm√§nnisch (pro Monat)</b></div>
        <div class="info-item"><span>Spesen 8h/14h/24h:</span><b id="inf-spesen"></b></div>
        <div class="info-item"><span>FAE Satz:</span><b id="inf-fae"></b></div>
        <div class="info-item"><span>Urlaub Gutschrift:</span><b id="inf-gut"></b></div>
        <div class="info-item"><span>Zusatzurlaub:</span><b>Pro <span id="inf-nac"></span> Nachtstunden</b></div>
    </div>
    <button onclick="toggleInfo()" style="margin-top: 20px;">Schlie√üen</button>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Tarif-Einstellungen</h2>
    <div class="grid"><div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div><div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div></div>
    <div class="grid"><div><label>Samstag ‚Ç¨/h</label><input type="number" id="cfg-samstag" step="0.01"></div><div><label>Sonntag ‚Ç¨/h</label><input type="number" id="cfg-sonntag" step="0.01"></div></div>
    <div class="grid"><div><label>Feiertag ‚Ç¨/h</label><input type="number" id="cfg-feiertag" step="0.01"></div><div><label>4 Uhr Bonus ‚Ç¨</label><input type="number" id="cfg-bonus" step="0.01"></div></div>
    <div class="grid"><div><label>FAE ‚Ç¨/Tag</label><input type="number" id="cfg-fahrt" step="0.01"></div><div><label>Urlaub h/Tag</label><input type="number" id="cfg-gutschrift" step="0.01"></div></div>
    <hr>
    <div class="grid"><div><label>Wege Hin</label><input type="number" id="cfg-wegeHin"></div><div><label>Wege R√ºck</label><input type="number" id="cfg-wegeRueck"></div></div>
    <div class="grid"><div><label>8h Spesen</label><input type="number" id="cfg-v1" step="0.01"></div><div><label>14h Spesen</label><input type="number" id="cfg-v2" step="0.01"></div></div>
    <div class="grid"><div><label>24h Spesen</label><input type="number" id="cfg-v3" step="0.01"></div><div><label>Urlaubsanspruch</label><input type="number" id="cfg-janspruch"></div></div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--p);">Google Kalender Sync</label>
        <div style="margin-bottom: 10px;">
            <label>Ziel-Kalender</label>
            <select id="cfg-calendarId">
                <option value="primary">Hauptkalender (Standard)</option>
            </select>
            <button onclick="listCalendars()" style="background:#64748b; padding:5px; font-size:0.7rem; margin-top:5px; color:white; border:none; border-radius:5px;">KALENDERLISTE LADEN</button>
        </div>
        <div class="grid">
            <div><label>API Key</label><input type="password" id="cfg-apiKey" placeholder="AIza..."></div>
            <div><label>Client ID</label><input type="text" id="cfg-clientId" placeholder="..."></div>
        </div>
        <button id="auth-btn" onclick="handleAuthClick()" style="background:#4285F4; margin-top:10px;">GOOGLE LOGIN</button>
        <button id="signout-btn" onclick="handleSignoutClick()" style="background:#64748b; margin-top:5px; display:none;">ABMELDEN</button>
        <button id="sync-all-btn" onclick="syncAllToGoogle()" style="background:#16a34a; margin-top:5px; display:none;">ALLE EINTR√ÑGE SYNC</button>
    </div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datensicherung</label>
        <button onclick="exportData()" style="background:#475569; margin-top:0; font-size:0.9rem;">üì• BACKUP KOPIEREN</button>
        <button onclick="exportJSONFile()" style="background:#2563eb; margin-top:8px; font-size:0.9rem;">üíæ ALS .JSON SPEICHERN</button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">üì§ IMPORT / DIENSTPLAN</button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN & SCHLIE·∫ûEN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Dienstplan hinzuf√ºgen</h2>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datei ausw√§hlen (.json)</label>
        <input type="file" id="import-file" accept=".json" onchange="processFileImport(this)">
    </div>
    <textarea id="import-area" style="width:100%; height:200px;" placeholder='JSON hier einf√ºgen'></textarea>
    <button onclick="processImport()" style="background:var(--success)">HINZUF√úGEN</button>
    <button onclick="toggleImport()">ABBRECHEN</button>
</div>

<div id="refresh-dialog" onclick="if(event.target===this) closeRefreshDialog()">
    <div class="dialog-content">
        <h3>Neu berechnen ab:</h3>
        <input type="date" id="refresh-date">
        <button onclick="recalculateFromDate()" style="background:var(--success)">STARTEN</button>
        <button onclick="closeRefreshDialog()">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <div id="btn-cancel-edit" class="btn-close-edit" onclick="cancelEdit()">√ó</div>
    <div id="edit-id-view" style="display:none; color:var(--warn); font-weight:bold; margin-bottom:10px; text-align:center;">‚úé BEARBEITEN AKTIV</div>
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum</label><input type="date" id="d" onchange="autoDetectDay()"></div><div><label>Typ</label><div id="type-display" style="padding:12px; background:#f1f5f9; border-radius:10px; text-align:center; font-weight:bold; font-size:0.8rem;">WERKTAG</div></div></div>
    <div class="grid"><div><label>Beginn</label><input type="time" id="s"></div><div><label>Ende</label><input type="time" id="e"></div></div>
    <div id="bereitschaft-felder" style="display:none; background: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 10px; margin-bottom: 12px;">
        <label>Einsatz ausw√§rts</label>
        <div class="grid"><div><label>Von</label><input type="time" id="ev"></div><div><label>Bis</label><input type="time" id="eb"></div></div>
    </div>
    <div class="pause-box">
        <div class="pause-row"><input type="time" id="p1s"><select id="pd1"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option><option value="45">45 Min</option><option value="60">60 Min</option></select></div>
        <div class="pause-row"><input type="time" id="p2s"><select id="pd2"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option></select></div>
    </div>
    <div class="grid">
        <div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><label>Korr. Hin</label><input type="number" id="korrHin" placeholder="Min"></div>
            <div><label>Korr. R√ºck</label><input type="number" id="korrRueck" placeholder="Min"></div>
        </div>
    </div>
    <div class="grid" style="align-items: center; justify-content: end;">
        <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="tr" checked style="width:22px; height:22px;"> FAE AKTIV</label>
    </div>
    <button id="main-btn" onclick="add()">Schicht speichern</button>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
        <button id="btn-bereit" class="btn-sub" onclick="toggleStatus('bereit')">Bereitschaft</button>
        <button id="btn-urlaub" class="btn-sub" onclick="toggleStatus('urlaub')">Urlaub</button>
        <button id="btn-krank" class="btn-sub" onclick="toggleStatus('krank')">Krank</button>
        <button id="btn-ruhe" class="btn-sub" onclick="toggleStatus('ruhe')">Ruhe</button>
    </div>
</div>

<div id="history"></div>
<div class="version-footer">V 1.1 | 05.02.2026</div>

<script>
    // --- FESTE WERTE (WERDEN NICHT GEL√ñSCHT) ---
    const DEFAULTS = {
        jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, 
        fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36,
        apiKey: 'DEIN_API_KEY', // HIER DEINEN API KEY EINTRAGEN
        clientId: 'DEINE_CLIENT_ID.apps.googleusercontent.com', // HIER CLIENT ID EINTRAGEN
        calendarId: 'primary'
    };

    let tokenClient, gapiInited=false, gisInited=false;
    const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    const wDaysShort = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
    
    // Lade Config und f√ºlle fehlende Werte mit Defaults auf
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {};
    config = { ...DEFAULTS, ...config };
    
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d);
    let openMonths = new Set([new Date().toISOString().substring(0,7)]), openYears = new Set([new Date().getFullYear().toString()]), activeStatus = 'Dienst';
    const holidays = getHolidays(2026);

    function getHolidays(year) {
        const fixed = [`${year}-01-01`, `${year}-03-08`, `${year}-05-01`, `${year}-10-03`, `${year}-12-25`, `${year}-12-26`];
        const a = year%19, b = Math.floor(year/100), c = year%100, d = Math.floor(b/4), e = b%4, f = Math.floor((b+8)/25), g = Math.floor((b-f+1)/3), h = (19*a+b-d-g+15)%30, i = Math.floor(c/4), k = c%4, l = (32+2*e+2*i-h-k)%7, m = Math.floor((a+11*h+22*l)/451), n = Math.floor((h+l-7*m+114)/31), p = (h+l-7*m+114)%31;
        const osterSonntag = new Date(year, n-1, p+1);
        const calc = (offset) => { let d = new Date(osterSonntag); d.setDate(osterSonntag.getDate()+offset); return d.toISOString().split('T')[0]; };
        return [...fixed, calc(-2), calc(1), calc(39), calc(50)];
    }

    function gapiLoaded() {
        if (!config.apiKey || config.apiKey.includes('DEIN_')) return;
        gapi.load('client', async () => {
            await gapi.client.init({apiKey: config.apiKey, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']});
            gapiInited = true; checkGReady();
        });
    }
    function gisLoaded() {
        if (!config.clientId || config.clientId.includes('DEINE_')) return;
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: config.clientId, 
            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly', 
            callback: ''
        });
        gisInited = true; checkGReady();
    }
    function checkGReady() { if (gapiInited && gisInited) document.getElementById('sync-info').innerText = "Google Kalender: Bereit"; }
    
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            document.getElementById('sync-info').innerText = "Verbunden";
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('signout-btn').style.display = 'block';
            document.getElementById('sync-all-btn').style.display = 'block';
            listCalendars();
        };
        tokenClient.requestAccessToken({prompt: gapi.client.getToken() === null ? 'consent' : ''});
    }

    async function listCalendars() {
        try {
            const response = await gapi.client.calendar.calendarList.list();
            const calendars = response.result.items;
            const select = document.getElementById('cfg-calendarId');
            select.innerHTML = '';
            calendars.forEach(cal => {
                const opt = document.createElement('option');
                opt.value = cal.id;
                opt.text = cal.summary + (cal.primary ? ' (Haupt)' : '');
                if(cal.id === config.calendarId) opt.selected = true;
                select.appendChild(opt);
            });
            showToast("Kalenderliste geladen");
        } catch (e) { console.error(e); }
    }

    async function syncToGoogle(r) {
        if (!gapi.client.getToken()) return;
        const st = r.status.toLowerCase();
        const calId = document.getElementById('cfg-calendarId').value || config.calendarId || 'primary';
        let event = { 'description': `${r.status} (${r.loc||'---'})`, 'start': {}, 'end': {} };

        if (['dienst', 'bereit'].includes(st)) {
            event.summary = `Arbeit ${r.s} - ${r.e}`;
            event.start.dateTime = `${r.d}T${r.s}:00`;
            let endD = new Date(`${r.d}T${r.e}:00`);
            if (timeToDec(r.e) <= timeToDec(r.s)) endD.setDate(endD.getDate()+1);
            event.end.dateTime = endD.toISOString().split('.')[0];
            event.start.timeZone = event.end.timeZone = 'Europe/Berlin';
        } else {
            event.summary = r.status;
            event.start.date = r.d;
            let nextD = new Date(r.d); nextD.setDate(nextD.getDate()+1);
            event.end.date = nextD.toISOString().split('T')[0];
        }

        try {
            const req = r.gEventId ? 
                gapi.client.calendar.events.patch({'calendarId': calId, 'eventId': r.gEventId, 'resource': event}) :
                gapi.client.calendar.events.insert({'calendarId': calId, 'resource': event});
            const res = await req; r.gEventId = res.result.id;
        } catch (e) { console.error(e); }
    }

    async function syncAllToGoogle() {
        if (!gapi.client.getToken()) return;
        if (confirm(`${data.length} Eintr√§ge synchronisieren?`)) {
            let i=0;
            for (let r of data) {
                // Kurze Pause, um Google-Sperren zu vermeiden
                await new Promise(res => setTimeout(res, 250));
                await syncToGoogle(r); i++;
                document.getElementById('sync-info').innerText = `Sync: ${i} / ${data.length}`;
            }
            localStorage.setItem('shifts_p10', JSON.stringify(data)); render();
            showToast("Sync abgeschlossen!");
        }
    }

    function timeToDec(t) { if(!t) return null; let [h,m]=t.split(':').map(Number); return h + m/60; }
    function calculateShift(r) {
        let sc=r.status.toLowerCase();
        if(['dienst','krank','bereit'].includes(sc)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e);
            if(sc==='krank'&&(t1===null||t2===null)) { r.h=config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; return r; }
            if(t1===null||t2===null) return r;
            if(t2<=t1) t2+=24;
            let n=0, sz=0, so=0, ft=0, w=0, p=[];
            if(r.p1s&&r.pd1>0){ let s=timeToDec(r.p1s); if(s<t1)s+=24; p.push({s, e:s+r.pd1/60}); }
            if(r.p2s&&r.pd2>0){ let s=timeToDec(r.p2s); if(s<t1)s+=24; p.push({s, e:s+r.pd2/60}); }
            for(let i=t1; i<t2; i+=(1/60)) {
                if(!p.some(pa=>i>=pa.s&&i<pa.e)) {
                    w+=(1/60); let c=i%24, dt=new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                    let isF=holidays.includes(dt.toISOString().split('T')[0]), isO=dt.getDay()===0, isA=dt.getDay()===6;
                    if(c>=20||c<6) n+=(1/60); if(isF) ft+=(1/60); else if(isO) so+=(1/60); else if(isA&&c>=13&&c<20) sz+=(1/60);
                }
            }
            r.h=w; r.nH=n; r.szH=sz; r.soH=so; r.ftH=ft;
            r.bonus=(sc!=='krank'&&((t1%24>=0&&t1%24<4)||(t2%24>0&&t2%24<=4)))?config.bonus:0;
            let abw=0; if(r.tr&&sc!=='krank') {
                let wh=(r.korrHin&&!isNaN(r.korrHin))?parseFloat(r.korrHin)/60:config.wegeHin/60;
                let wr=(r.korrRueck&&!isNaN(r.korrRueck))?parseFloat(r.korrRueck)/60:config.wegeRueck/60;
                let diff=(sc==='bereit')?timeToDec(r.eb)-timeToDec(r.ev):t2-t1;
                if(sc==='bereit'&&diff<=0) diff+=24; abw=(r.loc==='BRGB')?diff+wh+wr:diff-(7/60);
            }
            r.spesen=sc==='krank'?0:(Math.max(0,abw)>=8?(abw>=24?config.v3:(abw>=14?config.v2:config.v1)):0);
            r.fae=(r.tr&&sc!=='krank')?config.fahrt:0; r.faeCount=(r.tr&&sc!=='krank')?1:0;
        } else if(sc==='urlaub') { r.h=config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        else { r.h=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        return r;
    }
    async function add() {
        const d=document.getElementById('d').value; if(!d) return;
        const id=document.getElementById('edit-id').value;
        let r={ d, status:activeStatus, id:id?parseInt(id):Date.now(), s:document.getElementById('s').value, e:document.getElementById('e').value, p1s:document.getElementById('p1s').value, pd1:parseInt(document.getElementById('pd1').value), p2s:document.getElementById('p2s').value, pd2:parseInt(document.getElementById('pd2').value), ev:document.getElementById('ev').value, eb:document.getElementById('eb').value, loc:document.getElementById('loc').value, tr:document.getElementById('tr').checked, korrHin:document.getElementById('korrHin').value, korrRueck:document.getElementById('korrRueck').value };
        if(id){ const old=data.find(x=>x.id===parseInt(id)); if(old&&old.gEventId) r.gEventId=old.gEventId; }
        r=calculateShift(r); await syncToGoogle(r);
        if(id){ const idx=data.findIndex(x=>x.id===parseInt(id)); if(idx!==-1){ r.edited=true; data[idx]=r; } } else data.push(r);
        localStorage.setItem('shifts_p10', JSON.stringify(data)); cancelEdit(); render();
    }
    function render() {
        const cont=document.getElementById('history'); cont.innerHTML='';
        const ts=new Date().toISOString().split('T')[0], cy=new Date().getFullYear().toString();
        let th=0, tv=0, tree={};
        data.forEach(r=>{
            const y=r.d.substring(0,4), m=r.d.substring(0,7), fut=r.d>ts;
            if(!tree[y]) tree[y]={months:{}, stats:{krank:0, urlaub:0, arbeit:0, brgb:0}};
            if(!tree[y].months[m]) tree[y].months[m]={items:[], h:0, nH:0, szH:0, soH:0, ftH:0, bE:0, sp:0, fE:0, fC:0, br:0};
            const ys=tree[y].stats, mg=tree[y].months[m]; mg.items.push(r);
            if(!fut){
                if(r.status.toLowerCase()==='krank') ys.krank++;
                if(r.status.toLowerCase()==='urlaub'&&new Date(r.d).getDay()%6!==0){ ys.urlaub++; if(y===cy) tv++; }
                if(['dienst','bereit'].includes(r.status.toLowerCase())) ys.arbeit++;
                mg.h+=r.h; mg.nH+=r.nH; mg.szH+=r.szH; mg.soH+=r.soH; mg.ftH+=r.ftH; mg.bE+=r.bonus; mg.sp+=r.spesen; mg.fE+=r.fae; mg.fC+=(r.faeCount||0); if(r.loc==='BRGB') mg.br++;
                if(y===cy) th+=r.h;
            }
        });
        Object.keys(tree).sort().reverse().forEach(y=>{
            const yd=tree[y], yo=openYears.has(y);
            let h=`<div class="year-group"><div class="month-header year-header ${yo?'open':''}" onclick="toggleY('${y}')"><span>JAHR ${y}</span><div class="m-stats"><span>Arbeit: ${yd.stats.arbeit}</span></div></div><div class="month-content ${yo?'open':''}">`;
            Object.keys(yd.months).sort().reverse().forEach(m=>{
                const g=yd.months[m], mo=openMonths.has(m), mon=parseInt(m.split('-')[1]);
                h+=`<div style="margin:10px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"><div class="month-header ${mo?'open':''}" onclick="toggleM('${m}')"><span>${monthNames[mon-1]} <b>(${g.h.toFixed(1)}h)</b></span></div><div class="month-content ${mo?'open':''}">
                <table>${g.items.sort((a,b)=>new Date(b.d)-new Date(a.d)).map(i=>{
                    const wd=wDaysShort[new Date(i.d).getDay()], ds=i.status.charAt(0).toUpperCase()+i.status.slice(1);
                    return `<tr><td><b>${wd}, ${i.d.split('-').reverse().slice(0,2).join('.')}</b><br><small>${ds}</small></td><td>${i.s||'--'}-${i.e||'--'}<br><small>${i.h.toFixed(1)}h</small></td><td class="action-btns"><button class="btn-mini btn-edit" onclick="edit(${i.id})">‚úé</button><button class="btn-mini btn-del" onclick="del(${i.id})">üóë</button></td></tr>`;
                }).join('')}</table></div></div>`;
            });
            h+=`</div></div>`; cont.innerHTML+=h;
        });
        document.getElementById('h_sum').innerText=th.toFixed(2);
    }
    function saveConfig(){
        ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k=>{
            const v=document.getElementById('cfg-'+k).value;
            if(v !== "") config[k]=parseFloat(v); // Nur speichern wenn nicht leer
        });
        // API Keys nur speichern wenn sie nicht den Platzhalter-Text enthalten
        const api=document.getElementById('cfg-apiKey').value;
        const cli=document.getElementById('cfg-clientId').value;
        if(api && !api.includes('DEIN_')) config.apiKey = api;
        if(cli && !cli.includes('DEINE_')) config.clientId = cli;
        
        config.calendarId = document.getElementById('cfg-calendarId').value;
        localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); location.reload();
    }
    // Restliche UI Funktionen (toggle, del, etc.) wie gehabt...
    document.getElementById('d').value=new Date().toISOString().split('T')[0]; render();
</script>
</body>
</html>
