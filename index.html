<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #refresh-dialog, #import-panel, #tax-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        .pause-box { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .pause-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; border: 2px solid transparent; }
        
        .btn-sub.active { background: var(--success) !important; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white !important; transform: scale(1.02); }
        
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; gap: 4px; }
        .month-header .m-stats { font-size: 0.75rem; color: #94a3b8; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .month-header.open::after { content: '‚ñ≤'; font-size: 0.5rem; margin-left: 3px; }
        .month-header:not(.open)::after { content: '‚ñº'; font-size: 0.5rem; margin-left: 3px; }
        .month-details-bar { background: #1a222f; color: #cbd5e0; padding: 12px 15px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; border-bottom: 2px solid #2d3748; }
        .detail-row { display: flex; justify-content: space-between; padding: 4px 6px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 2px solid transparent; }
        .row-nazu { border-left-color: #38bdf8; }
        .row-fae { border-left-color: #fbbf24; }
        .row-sazu { border-left-color: #818cf8; }
        .row-brgb { border-left-color: #f87171; }
        .row-sozu { border-left-color: #4ade80; }
        .row-fezu { border-left-color: #f472b6; }
        .row-4uhr { border-left-color: #2dd4bf; }
        .row-nacht-count { border-left-color: #a78bfa; }
        
        .val-h { color: #38bdf8; font-weight: 500; }
        .val-eur { color: #4ade80; font-weight: 800; font-family: monospace; }
        .val-count { color: #fbbf24; font-weight: 800; }
        .spesen-bar { background: #111827; color: #4ade80; padding: 10px 15px; font-size: 0.9rem; border-bottom: 1px solid #4a5568; font-weight: bold; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; background: white; border-collapse: separate; }
        tr:nth-child(even) { background: #f8fafc; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        
        .type-dienst td:first-child { border-left: 5px solid var(--p) !important; }
        .type-bereit td:first-child, .type-dispo td:first-child { border-left: 5px solid var(--warn) !important; }
        .type-krank td:first-child { border-left: 5px solid var(--danger) !important; }
        .type-urlaub td:first-child { border-left: 5px solid var(--success) !important; }
        .type-ruhe td:first-child, .type-schulung td:first-child { border-left: 5px solid #64748b !important; }

        .row-today { background-color: rgba(37, 99, 235, 0.08) !important; }
        .is-future td:not(.action-btns) { opacity: 0.45; }
        
        .row-status-info { font-size: 0.65rem; color: #64748b; margin-top: 4px; display: flex; gap: 8px; }

        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-mini { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 35px; height: 35px; }
        .btn-edit { background: var(--p); }
        .btn-del { background: var(--danger); }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; }
        .btn-close-edit { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #e2e8f0; color: #64748b; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .header-info-row { font-size: 0.8rem; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); line-height: 1.4; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .year-header { background: #0f172a; color: #38bdf8; font-weight: 800; border-bottom: 2px solid #38bdf8; }
        .version-footer { text-align: center; font-size: 0.65rem; color: #94a3b8; margin-top: 40px; padding-bottom: 20px; line-height: 1.5; }
        .is-edited-mark { color: var(--warn); font-weight: bold; font-size: 1rem; margin-left: 4px; }
        .highlight-row { animation: highlightFade 2s ease-out; }
        @keyframes highlightFade { 0% { background-color: rgba(37, 99, 235, 0.2); } 100% { background-color: transparent; } }
    </style>
</head>
<body>

<div id="toast" class="toast">In Zwischenablage kopiert!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Status 2026</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist (bis heute)</small><br><strong id="h_sum">0.00</strong> <small>h</small></div>
        <div><small>Saldo Aktuell</small><br><strong id="d_sum">0.00</strong> <small>h</small></div>
        <div style="text-align:right"><small>Soll Restjahr</small><br><strong id="s_offen">0.00</strong> <small>h</small></div>
    </div>
    <div class="header-info-row">
        <div id="vac-summary">Urlaub: 0 / 36</div>
        <div id="extra-vac-summary" style="color: #93c5fd;">Zusatzurlaub: 0 Tage (0.00/96.00h)</div>
    </div>
    <div class="progress-bar"><div id="p_fill" class="progress-fill"></div></div>
    <div style="font-size: 0.6rem; margin-top: 5px; opacity: 0.8; text-align: center;" id="p_text">Berechne...</div>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Tarif-Einstellungen</h2>
    <div class="grid"><div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div><div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div></div>
    <div class="grid"><div><label>Samstag ‚Ç¨/h</label><input type="number" id="cfg-samstag" step="0.01"></div><div><label>Sonntag ‚Ç¨/h</label><input type="number" id="cfg-sonntag" step="0.01"></div></div>
    <div class="grid"><div><label>Feiertag ‚Ç¨/h</label><input type="number" id="cfg-feiertag" step="0.01"></div><div><label>4 Uhr Bonus ‚Ç¨</label><input type="number" id="cfg-bonus" step="0.01"></div></div>
    <div class="grid"><div><label>FAE ‚Ç¨/Tag</label><input type="number" id="cfg-fahrt" step="0.01"></div><div><label>Urlaub h/Tag</label><input type="number" id="cfg-gutschrift" step="0.01"></div></div>
    <hr>
    
    <button onclick="toggleTaxPanel()" style="background:#2563eb; margin-bottom: 15px;">üìä STEUER-EINSTELLUNGEN</button>

    <div class="grid"><div><label>Wege Hin</label><input type="number" id="cfg-wegeHin"></div><div><label>Wege R√ºck</label><input type="number" id="cfg-wegeRueck"></div></div>
    <div class="grid"><div><label>8h Spesen</label><input type="number" id="cfg-v1" step="0.01"></div><div><label>14h Spesen</label><input type="number" id="cfg-v2" step="0.01"></div></div>
    <div class="grid"><div><label>24h Spesen</label><input type="number" id="cfg-v3" step="0.01"></div><div><label>Urlaubsanspruch</label><input type="number" id="cfg-janspruch"></div></div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datensicherung</label>
        <button onclick="exportData()" style="background:#475569; margin-top:0; font-size:0.9rem;">üì• BACKUP KOPIEREN</button>
        <button onclick="exportJSONFile()" style="background:#2563eb; margin-top:8px; font-size:0.9rem;">üíæ ALS .JSON SPEICHERN</button>
        <button onclick="exportToGoogleCalendar()" style="background:#1a73e8; margin-top:8px; font-size:0.9rem;">üìÖ GOOGLE KALENDER SYNC (iCAL)</button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">üì§ IMPORT / DIENSTPLAN</button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN & SCHLIE·∫ûEN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="tax-panel">
    <h2 style="margin-top:0">Steuer-Parameter</h2>
    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 20px;">Hier die Daten f√ºr die pr√§zise Netto-Berechnung eingeben:</p>
    
    <div class="grid">
        <div><label>Brutto Monat</label><input type="number" id="tax-brutto" step="0.01"></div>
        <div><label>Steuerklasse</label><input type="number" id="tax-stkl"></div>
    </div>
    <div class="grid">
        <div><label>Kinderfreibetrag</label><input type="number" id="tax-kinder" step="0.5"></div>
        <div><label>Zusatzbeitrag %</label><input type="number" id="tax-kk" step="0.01"></div>
    </div>
    <div class="grid">
        <div><label>Bundesland</label>
            <select id="tax-bland">
                <option value="Berlin">Berlin</option>
                <option value="Brandenburg">Brandenburg</option>
                <option value="Bayern">Bayern</option>
                <option value="Hessen">Hessen</option>
            </select>
        </div>
        <div><label>Kirchensteuer</label>
            <select id="tax-kirche">
                <option value="0">Nein</option>
                <option value="8">8%</option>
                <option value="9">9%</option>
            </select>
        </div>
    </div>
    <div style="margin-bottom: 15px;">
        <label>Rentenniveau / Sonderstatus</label>
        <select id="tax-rentner">
            <option value="0">Normalarbeitnehmer</option>
            <option value="1">Rentner / Pension√§r</option>
        </select>
    </div>

    <button onclick="saveTaxSettings()" style="background:var(--success)">√úBERNEHMEN</button>
    <button onclick="toggleTaxPanel()" style="background:#64748b; margin-top:10px">ZUR√úCK</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Dienstplan hinzuf√ºgen</h2>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datei ausw√§hlen (.json)</label>
        <input type="file" id="import-file" accept=".json" onchange="processFileImport(this)">
    </div>
    <p style="font-size: 0.8rem; color: #64748b;">Oder Dienstplan-Text hier einf√ºgen (JSON):</p>
    <textarea id="import-area" style="width:100%; height:250px; font-family:monospace; font-size:0.7rem; margin-bottom:15px;" placeholder='{"data":[...]}'></textarea>
    <button onclick="processImport()" style="background:var(--success)">SCHICHTEN HINZUF√úGEN</button>
    <button onclick="toggleImport()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="refresh-dialog" onclick="if(event.target===this) closeRefreshDialog()">
    <div class="dialog-content">
        <h3 style="margin-top:0">Tarif-Update</h3>
        <p style="font-size: 0.8rem; color: #64748b;">Ab welchem Datum sollen Schichten neu berechnet werden?</p>
        <input type="date" id="refresh-date" style="margin-bottom:15px;">
        <button onclick="recalculateFromDate()" style="background:var(--success)">NEU BERECHNEN</button>
        <button onclick="closeRefreshDialog()" style="background:#64748b; margin-top:8px;">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <div id="btn-cancel-edit" class="btn-close-edit" onclick="cancelEdit()">√ó</div>
    <div id="edit-id-view" style="display:none; color:var(--warn); font-weight:bold; margin-bottom:10px; text-align:center;">‚úé BEARBEITEN AKTIV</div>
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum (Von)</label><input type="date" id="d" onchange="autoDetectDay()"></div><div><label>Typ</label><div id="type-display" style="padding:12px; background:#f1f5f9; border-radius:10px; text-align:center; font-weight:bold; font-size:0.8rem;">WERKTAG</div></div></div>
    
    <div id="date-range-box" class="grid" style="display:none;"><div><label>Datum (Bis)</label><input type="date" id="d_end"></div><div></div></div>

    <div class="grid" id="time-grid"><div><label>Beginn</label><input type="time" id="s" onchange="checkNightShift()"></div><div><label>Ende</label><input type="time" id="e" onchange="checkNightShift()"></div></div>
    
    <div id="dispo-presets" style="display:none; margin-bottom: 12px; gap: 8px; grid-template-columns: 1fr 1fr 1fr;" class="grid">
        <button class="btn-sub" onclick="setDispoTime('04:00','12:00')">Fr√ºh (4-12)</button>
        <button class="btn-sub" onclick="setDispoTime('12:00','20:00')">Tag (12-20)</button>
        <button class="btn-sub" onclick="setDispoTime('20:00','04:00')">Nacht (20-4)</button>
    </div>

    <div style="margin-bottom: 12px;">
        <label>Gutgeschriebene Stunden (Bonus)</label>
        <input type="number" id="extra_h" step="0.01" placeholder="z.B. 4.0">
    </div>

    <div id="bereitschaft-felder" class="bereitschaft-extra" style="display:none; background: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 10px; margin-bottom: 12px;">
        <label style="color:var(--warn); margin-bottom:8px; display:block;">Einsatz ausw√§rts (f√ºr Ausbleibezeit)</label>
        <div class="grid"><div><label>Von</label><input type="time" id="ev"></div><div><label>Bis</label><input type="time" id="eb"></div></div>
    </div>

    <div class="pause-box">
        <label>Pause 1 (Beginn & Dauer)</label>
        <div class="pause-row"><input type="time" id="p1s"><select id="pd1"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option><option value="45">45 Min</option><option value="60">60 Min</option></select></div>
        <label>Pause 2 (Beginn & Dauer)</label>
        <div class="pause-row"><input type="time" id="p2s"><select id="pd2"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option></select></div>
    </div>
    <div class="grid" id="loc-section">
        <div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><label>Korr. Hin</label><input type="number" id="korrHin" placeholder="Min"></div>
            <div><label>Korr. R√ºck</label><input type="number" id="korrRueck" placeholder="Min"></div>
        </div>
    </div>
    <div class="grid" style="align-items: center; justify-content: end;" id="fae-section">
        <label style="display:flex; align-items:center; gap:8px; cursor: pointer;"><input type="checkbox" id="tr" checked style="width:22px; height:22px;"> FAE AKTIV</label>
    </div>
    <button id="main-btn" onclick="add()">Schicht speichern</button>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
        <button id="btn-bereit" class="btn-sub" onclick="toggleStatus('bereit')">Bereitschaft</button>
        <button id="btn-dispo" class="btn-sub" onclick="toggleStatus('dispo')">Dispo</button>
        <button id="btn-urlaub" class="btn-sub" onclick="toggleStatus('urlaub')">Urlaub</button>
        <button id="btn-krank" class="btn-sub" onclick="toggleStatus('krank')">Krank</button>
        <button id="btn-ruhe" class="btn-sub" onclick="toggleStatus('ruhe')">Ruhe</button>
        <button id="btn-ruhe-nacht" class="btn-sub" onclick="toggleStatus('ruhe-nacht')">Ruhe Nach Nacht</button>
        <button id="btn-krank-nacht" class="btn-sub" onclick="toggleStatus('krank-nacht')">Krank Nach Nacht</button>
        <button id="btn-schulung" class="btn-sub" onclick="toggleStatus('schulung')">Schulung</button>
    </div>
</div>

<div id="history"></div>

<div class="version-footer">
    Aktuelle Versionsnummer 3.2.3<br>
    Stand: 12.02.2026, 20:30 Uhr
</div>

<script>
    function getHolidays(year) {
        const fixed = [`${year}-01-01`, `${year}-03-08`, `${year}-05-01`, `${year}-10-03`, `${year}-12-25`, `${year}-12-26`];
        const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), n = Math.floor((h + l - 7 * m + 114) / 31), p = (h + l - 7 * m + 114) % 31;
        const osterSonntag = new Date(year, n - 1, p + 1);
        const calc = (offset) => { let d = new Date(osterSonntag); d.setDate(osterSonntag.getDate() + offset); return d.toISOString().split('T')[0]; };
        return [...fixed, calc(-2), calc(1), calc(39), calc(50)];
    }

    const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    const wDaysShort = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
    
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    
    let taxConfig = JSON.parse(localStorage.getItem('shifts_tax_cfg')) || {brutto: 0, stkl: 1, kinder: 0, kk: 1.6, bland: 'Berlin', kirche: 0, rentner: 0};

    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d);
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let openYears = new Set([new Date().getFullYear().toString()]);
    let openOthers = new Set();
    let activeStatus = 'Dienst';

    function showToast(txt) { const t=document.getElementById('toast'); t.innerText=txt; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }

    function updateDispoPresets() {
        const s = document.getElementById('s').value;
        const e = document.getElementById('e').value;
        const buttons = document.querySelectorAll('#dispo-presets button');
        if (buttons.length === 3) {
            buttons[0].classList.toggle('active', s === '04:00' && e === '12:00');
            buttons[1].classList.toggle('active', s === '12:00' && e === '20:00');
            buttons[2].classList.toggle('active', s === '20:00' && e === '04:00');
        }
    }

    function checkNightShift() {
        const d_start = document.getElementById('d').value;
        const s = document.getElementById('s').value;
        const e = document.getElementById('e').value;
        if(!d_start) return;
        let d_end = d_start;
        if(s && e) {
            if(timeToDec(e) <= timeToDec(s)) {
                let dt = new Date(d_start);
                dt.setDate(dt.getDate() + 1);
                d_end = dt.toISOString().split('T')[0];
                document.getElementById('date-range-box').style.display = 'grid';
            } else {
                if(!['Urlaub', 'Krank', 'Ruhe', 'Schulung'].includes(activeStatus)) {
                    document.getElementById('date-range-box').style.display = 'none';
                }
            }
        }
        document.getElementById('d_end').value = d_end;
        updateDispoPresets();
    }

    async function exportData() {
        const str = JSON.stringify({ data, config, taxConfig, date: new Date().toLocaleString() });
        try { await navigator.clipboard.writeText(str); showToast("Backup in Zwischenablage!"); } catch (err) { alert("Kopieren fehlgeschlagen."); }
    }

    function exportJSONFile() {
        const str = JSON.stringify({ data, config, taxConfig, date: new Date().toISOString() }, null, 2);
        const blob = new Blob([str], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Schichten_Backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function toggleImport() {
        const p = document.getElementById('import-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    function processFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            applyImportData(e.target.result);
            input.value = '';
        };
        reader.readAsText(file);
    }

    function processImport() {
        const raw = document.getElementById('import-area').value.trim();
        if(!raw) return;
        applyImportData(raw);
    }

    function applyImportData(jsonStr) {
        try {
            const p = JSON.parse(jsonStr);
            if(p.taxConfig) taxConfig = p.taxConfig;
            if(p.data && Array.isArray(p.data)) {
                let added = 0;
                let conflicts = 0;
                p.data.forEach(item => {
                    if(!item.d_end && item.s && item.e) {
                        if(timeToDec(item.e) <= timeToDec(item.s)) {
                            let dt = new Date(item.d);
                            dt.setDate(dt.getDate() + 1);
                            item.d_end = dt.toISOString().split('T')[0];
                        } else {
                            item.d_end = item.d;
                        }
                    } else if (!item.d_end) {
                        item.d_end = item.d;
                    }
                    const exists = data.some(existing => existing.id === item.id);
                    const conflict = checkConflicts(item);
                    if(!exists && !conflict) {
                        const processed = calculateShift(item);
                        data.push(processed);
                        added++;
                    } else if (conflict && !exists) {
                        conflicts++;
                    }
                });
                localStorage.setItem('shifts_p10', JSON.stringify(data));
                localStorage.setItem('shifts_tax_cfg', JSON.stringify(taxConfig));
                render();
                toggleImport();
                if(conflicts > 0) {
                    alert(`${added} Schichten importiert. ${conflicts} Schichten √ºbersprungen wegen Konflikten mit deiner Vorplanung (Ruhe/Urlaub).`);
                } else {
                    alert(`${added} neue Schichten erfolgreich hinzugef√ºgt!`);
                }
            } else {
                alert("Format ung√ºltig: Das 'data' Array fehlt.");
            }
        } catch(e) {
            alert("Fehler beim Verarbeiten der Daten.");
        }
    }

    function timeToDec(t) { if(!t) return null; let [h,m]=t.split(':').map(Number); return h + m/60; }
    function openRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'flex'; document.getElementById('refresh-date').value = new Date().toISOString().split('T')[0]; }
    function closeRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'none'; }
    function recalculateFromDate() {
        const startD = document.getElementById('refresh-date').value; if(!startD) return;
        data = data.map(r => r.d >= startD ? calculateShift(r) : r);
        localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); closeRefreshDialog();
    }
    
    function toggleConfig() { 
        const p = document.getElementById('config-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block';
        if(p.style.display === 'block') ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => document.getElementById('cfg-'+k).value = config[k] || 0);
    }
    
    function saveConfig() {
        ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => { config[k] = parseFloat(document.getElementById('cfg-'+k).value) || 0; });
        localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render();
    }

    function toggleTaxPanel() {
        const p = document.getElementById('tax-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        if(p.style.display === 'block') {
            document.getElementById('tax-brutto').value = taxConfig.brutto;
            document.getElementById('tax-stkl').value = taxConfig.stkl;
            document.getElementById('tax-kinder').value = taxConfig.kinder;
            document.getElementById('tax-kk').value = taxConfig.kk;
            document.getElementById('tax-bland').value = taxConfig.bland;
            document.getElementById('tax-kirche').value = taxConfig.kirche;
            document.getElementById('tax-rentner').value = taxConfig.rentner;
        }
    }

    function saveTaxSettings() {
        taxConfig = {
            brutto: parseFloat(document.getElementById('tax-brutto').value) || 0,
            stkl: parseInt(document.getElementById('tax-stkl').value) || 1,
            kinder: parseFloat(document.getElementById('tax-kinder').value) || 0,
            kk: parseFloat(document.getElementById('tax-kk').value) || 1.6,
            bland: document.getElementById('tax-bland').value,
            kirche: parseInt(document.getElementById('tax-kirche').value) || 0,
            rentner: parseInt(document.getElementById('tax-rentner').value) || 0
        };
        localStorage.setItem('shifts_tax_cfg', JSON.stringify(taxConfig));
        toggleTaxPanel();
        showToast("Steuer-Daten gespeichert!");
    }
    
    function autoDetectDay() {
        const dStr = document.getElementById('d').value; if(!dStr) return;
        const dt = new Date(dStr); let l = 'üè¢ WERKTAG';
        const yearHolidays = getHolidays(dt.getFullYear());
        if(yearHolidays.includes(dStr)) l='üö© FEIERTAG'; else if(dt.getDay()===0) l='‚òÄÔ∏è SONNTAG'; else if(dt.getDay()===6) l='üìÖ SAMSTAG';
        document.getElementById('type-display').innerText = l;
        checkContextButtons(dStr);
        checkNightShift();
    }

    function checkContextButtons(date) {
        const normalBtns = ['btn-krank', 'btn-ruhe'];
        const contextBtns = ['btn-ruhe-nacht', 'btn-krank-nacht'];
        normalBtns.forEach(id => { if(document.getElementById(id)) document.getElementById(id).style.display = 'block'; });
        contextBtns.forEach(id => { if(document.getElementById(id)) document.getElementById(id).style.display = 'block'; });
    }

    function setDispoTime(start, end) {
        document.getElementById('s').value = start;
        document.getElementById('e').value = end;
        checkNightShift();
        updateDispoPresets();
    }
    
    function toggleStatus(st) { 
        let displayNames = {
            'bereit': 'Bereit', 'dispo': 'Dispo', 'urlaub': 'Urlaub', 'krank': 'Krank',
            'ruhe': 'Ruhe', 'schulung': 'Schulung', 'ruhe-nacht': 'Ruhe Nach Nacht',
            'krank-nacht': 'Krank Nach Nacht'
        };
        activeStatus = displayNames[st] || 'Dienst'; 
        const isTimedOff = ['Ruhe Nach Nacht', 'Krank Nach Nacht'].includes(activeStatus);
        const isAllDayOff = ['Urlaub', 'Ruhe', 'Krank', 'Schulung'].includes(activeStatus);
        const showTimes = !isAllDayOff || isTimedOff;
        document.getElementById('time-grid').style.display = showTimes ? 'grid' : 'none';
        Object.keys(displayNames).forEach(b => {
            const btn = document.getElementById('btn-'+b);
            if(btn) btn.classList.toggle('active', activeStatus === displayNames[b]);
        }); 
        document.getElementById('bereitschaft-felder').style.display = (activeStatus === 'Bereit') ? 'block' : 'none'; 
        document.getElementById('dispo-presets').style.display = (activeStatus === 'Dispo') ? 'grid' : 'none';
        document.getElementById('date-range-box').style.display = (isAllDayOff && !isTimedOff) ? 'grid' : 'none';
        const hideExtra = ['Urlaub', 'Krank', 'Ruhe', 'Schulung', 'Ruhe Nach Nacht', 'Krank Nach Nacht'].includes(activeStatus);
        document.getElementById('loc-section').style.display = hideExtra ? 'none' : 'grid';
        document.getElementById('fae-section').style.display = hideExtra ? 'none' : 'grid';
        if(isTimedOff && !document.getElementById('e').value) document.getElementById('e').value = '23:59';
        if(!isAllDayOff && !isTimedOff) checkNightShift();
        if(activeStatus === 'Dispo') updateDispoPresets();
    }

    function calculateShift(r) {
        let statusCheck = r.status.toLowerCase();
        let baseH = 0;
        if(['dienst','krank','bereit','dispo','ruhe nach nacht','krank nach nacht'].includes(statusCheck)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e); 
            if((statusCheck === 'krank' || statusCheck === 'krank nach nacht') && (t1 === null || t2 === null)) {
                baseH = config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; 
            } else if (t1 !== null && t2 !== null) {
                if(t2<=t1) t2+=24;
                let n=0, sz=0, so=0, ft=0, w=0;
                let p = []; if(r.p1s && r.pd1>0){ let s=timeToDec(r.p1s); if(s<t1)s+=24; p.push({s, e:s+r.pd1/60}); } if(r.p2s && r.pd2>0){ let s=timeToDec(r.p2s); if(s<t1)s+=24; p.push({s, e:s+r.pd2/60}); }
                for(let i=t1; i<t2; i+=(1/60)) {
                    if(!p.some(pa => i>=pa.s && i<pa.e)) {
                        w+=(1/60); let c=i%24, dt=new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                        const loopHolidays = getHolidays(dt.getFullYear());
                        let isF=loopHolidays.includes(dt.toISOString().split('T')[0]), isO=dt.getDay()===0, isA=dt.getDay()===6;
                        if(c>=20 || c<6) n+=(1/60); if(isF) ft+=(1/60); else if(isO) so+=(1/60); else if(isA && c>=13 && c<20) sz+=(1/60);
                    }
                }
                if(statusCheck === 'krank nach nacht') baseH = config.gutschrift; else baseH=w;
                if(statusCheck === 'ruhe nach nacht') baseH = 0;
                r.nH=n; r.szH=sz; r.soH=so; r.ftH=ft;
                r.bonus=(!['krank','krank nach nacht','ruhe nach nacht'].includes(statusCheck) && ((t1%24>=0 && t1%24<4) || (t2%24>0 && t2%24<=4))) ? config.bonus : 0;
                let abw = 0;
                if (r.tr && !['krank','krank nach nacht','ruhe nach nacht'].includes(statusCheck)) { 
                    let wH = (r.korrHin && !isNaN(r.korrHin)) ? (parseFloat(r.korrHin)/60) : (config.wegeHin/60);
                    let wR = (r.korrRueck && !isNaN(r.korrRueck)) ? (parseFloat(r.korrRueck)/60) : (config.wegeRueck/60);
                    let diff = (statusCheck === 'bereit') ? (timeToDec(r.eb) - timeToDec(r.ev)) : (t2-t1);
                    if(statusCheck === 'bereit' && (timeToDec(r.eb) <= timeToDec(r.ev))) diff += 24;
                    abw = (r.loc === 'BRGB') ? (diff + wH + wR) : (diff - (7/60));
                }
                r.spesen = ['krank','krank nach nacht','ruhe nach nacht'].includes(statusCheck)?0:(Math.max(0, abw)>=8 ? (abw>=24?config.v3:(abw>=14?config.v2:config.v1)) : 0);
                r.fae = (r.tr && !['krank','krank nach nacht','ruhe nach nacht'].includes(statusCheck)) ? config.fahrt : 0; r.faeCount = (r.tr && !['krank','krank nach nacht','ruhe nach nacht'].includes(statusCheck)) ? 1 : 0;
            }
        } else if(statusCheck==='urlaub' || statusCheck==='schulung' || statusCheck==='ruhe') { 
            baseH=statusCheck==='ruhe'?0:config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; 
        } else { 
            baseH=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; 
        }
        r.h = baseH + (parseFloat(r.extra_h) || 0);
        return r;
    }

    function checkConflicts(newR) {
        const nS = new Date(newR.d + 'T' + (newR.s || '00:00')).getTime();
        let nE = new Date((newR.d_end || newR.d) + 'T' + (newR.e || '23:59')).getTime();
        return data.some(oldR => {
            if(oldR.id === newR.id) return false;
            const oS = new Date(oldR.d + 'T' + (oldR.s || '00:00')).getTime();
            let oE = new Date((oldR.d_end || oldR.d) + 'T' + (oldR.e || '23:59')).getTime();
            return (nS < oE && nE > oS);
        });
    }

    function add() {
        const d_start=document.getElementById('d').value; if(!d_start) return;
        const d_end_in=document.getElementById('d_end').value;
        const id=document.getElementById('edit-id').value;
        const extraHValue = document.getElementById('extra_h').value;
        let loopStart = new Date(d_start);
        let loopEnd = (d_end_in && !id && ['Urlaub','Krank','Ruhe','Schulung'].includes(activeStatus)) ? new Date(d_end_in) : new Date(d_start);
        let lastId = null;
        let hasConflict = false;
        while(loopStart <= loopEnd) {
            const currentD = loopStart.toISOString().split('T')[0];
            let newId = id ? parseInt(id) : (Date.now() + Math.floor(Math.random() * 999999) + loopStart.getTime());
            let formattedStatus = activeStatus;
            let r={ 
                d: currentD, 
                d_end: document.getElementById('d_end').value || currentD, 
                status:formattedStatus, 
                id:newId, 
                s:document.getElementById('s').value, 
                e:document.getElementById('e').value, 
                p1s:document.getElementById('p1s').value, 
                pd1:parseInt(document.getElementById('pd1').value), 
                p2s:document.getElementById('p2s').value, 
                pd2:parseInt(document.getElementById('pd2').value), 
                ev:document.getElementById('ev').value, 
                eb:document.getElementById('eb').value, 
                loc:document.getElementById('loc').value, 
                tr:document.getElementById('tr').checked, 
                korrHin:document.getElementById('korrHin').value, 
                korrRueck:document.getElementById('korrRueck').value,
                extra_h: extraHValue
            };
            const overwriteStatuses = ['Urlaub', 'Krank', 'Ruhe', 'Schulung'];
            if (overwriteStatuses.includes(formattedStatus)) {
                data = data.filter(x => x.d !== currentD || (id && x.id === parseInt(id)));
            } else {
                if(checkConflicts(r)) {
                    alert(`Konflikt am ${currentD}! Schicht √ºberschneidet sich mit bestehendem Eintrag.`);
                    hasConflict = true;
                    break;
                }
            }
            if(id) { r.isEdited = true; data=data.filter(x=>x.id!==parseInt(id)); }
            r=calculateShift(r); data.push(r); lastId = r.id;
            loopStart.setDate(loopStart.getDate() + 1);
        }
        if(!hasConflict) {
            localStorage.setItem('shifts_p10', JSON.stringify(data)); 
            cancelEdit(); render();
            if(lastId) {
                setTimeout(() => {
                    const el = document.getElementById('row-' + lastId);
                    if(el) { el.scrollIntoView({behavior: 'smooth', block: 'center'}); el.classList.add('highlight-row'); }
                }, 100);
            }
        }
    }

    function del(id) {
        if(confirm('M√∂chtest du diesen Eintrag wirklich l√∂schen?')) {
            data = data.filter(r => r.id !== id);
            localStorage.setItem('shifts_p10', JSON.stringify(data));
            render();
        }
    }

    function toggleOthers(y) { openOthers.has(y)?openOthers.delete(y):openOthers.add(y); render(); }

    function render() {
        const cont = document.getElementById('history'); cont.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const currentYear = new Date().getFullYear().toString();
        const now = new Date();
        const focusMonths = [];
        for(let i = -1; i <= 1; i++) {
            focusMonths.push(new Date(now.getFullYear(), now.getMonth() + i, 1).toISOString().substring(0,7));
        }
        let tH_total=0, tV_total=0, tN_total=0; 
        const tree = {};
        data.forEach(r => {
            const y = r.d.substring(0,4), m = r.d.substring(0,7), isFuture = r.d > todayStr;
            const yearHolidays = getHolidays(parseInt(y));
            if(!tree[y]) tree[y] = { months: {}, stats: { krank: 0, urlaub: 0, arbeit: 0, brgb: 0, nCounts: 0 } };
            if(!tree[y].months[m]) tree[y].months[m] = { items: [], h:0, nH:0, szH:0, soH:0, ftH:0, bE:0, sp:0, fE:0, fC:0, br:0, nCounts: 0 };
            const yS = tree[y].stats, mG = tree[y].months[m];
            mG.items.push(r);
            let st = r.status.toLowerCase();
            if(!isFuture) {
                if(st.includes('krank')) yS.krank++;
                if(st === 'urlaub' && new Date(r.d).getDay()%6!==0 && !yearHolidays.includes(r.d)) { yS.urlaub++; if(y === currentYear) tV_total++; }
                if(st === 'dienst' || st === 'bereit' || st === 'dispo') yS.arbeit++;
                if(r.nH > 0) { yS.nCounts++; mG.nCounts++; }
                mG.h+=r.h; mG.nH+=r.nH; mG.szH+=r.szH; mG.soH+=r.soH; mG.ftH+=r.ftH; mG.bE+=r.bonus; mG.sp+=r.spesen; mG.fE+=r.fae; mG.fC+=(r.faeCount||0);
                if(y === currentYear) { tH_total += r.h; tN_total += r.nH; }
            }
        });
        let nowTime=new Date(), diffD=Math.max(1, Math.ceil((nowTime-new Date(currentYear,0,1))/864e5)), sollH=(config.jsoll/365)*diffD;
        document.getElementById('h_sum').innerText=tH_total.toFixed(2); document.getElementById('d_sum').innerText=(tH_total-sollH).toFixed(2); document.getElementById('s_offen').innerText=(config.jsoll-tH_total).toFixed(2);
        const nSollH = (config.gutschrift * 60) / 5;
        let roundedTotalN = 0;
        Object.keys(tree).forEach(y => { if(y === currentYear) { Object.keys(tree[y].months).forEach(m => { roundedTotalN += Math.round(tree[y].months[m].nH); }); } });
        document.getElementById('vac-summary').innerText=`Urlaub: ${tV_total}/${config.janspruch}`;
        document.getElementById('extra-vac-summary').innerText=`Zusatzurlaub: ${Math.floor(roundedTotalN/nSollH)} Tage (${roundedTotalN.toFixed(0)}/${nSollH.toFixed(0)}h)`;
        document.getElementById('p_fill').style.width=Math.min(100,(tH_total/config.jsoll*100))+"%"; 
        document.getElementById('p_text').innerText=`${(tH_total/config.jsoll*100).toFixed(1)}% von ${config.jsoll.toFixed(1)}h (${currentYear})`;
        Object.keys(tree).sort().reverse().forEach(y => {
            const yData = tree[y], yOpen = openYears.has(y);
            let yearHtml = `<div class="year-group"><div class="month-header year-header ${yOpen?'open':''}" onclick="toggleY('${y}')"><span>JAHR ${y}</span><div class="m-stats"><span>N√§chte: ${yData.stats.nCounts}</span><span>Urlaub: ${yData.stats.urlaub}</span></div></div><div class="month-content ${yOpen?'open':''}">`;
            let focusHtml = ""; let otherHtml = ""; let otherCount = 0;
            Object.keys(yData.months).sort().reverse().forEach(m => {
                const mG = yData.months[m], mOpen = openMonths.has(m), [yr, mo] = m.split('-');
                const isFocus = focusMonths.includes(m);
                const rNH = Math.round(mG.nH), nE = rNH * config.nacht, szE=mG.szH*config.samstag, soE=mG.soH*config.sonntag, ftE=mG.ftH*config.feiertag, brutto=nE+szE+soE+ftE+mG.bE, nV=(nE+soE+ftE+mG.sp+mG.fE)+((szE+mG.bE)*0.65);
                let mHtml = `<div style="margin: 10px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;"><div class="month-header ${mOpen?'open':''}" onclick="toggleM('${m}')"><span>${monthNames[parseInt(mo)-1]} <b>(${mG.h.toFixed(1)}h)</b></span><div class="m-stats" ${mOpen?'style="display:none"':''}><span>N√§chte: ${mG.nCounts}</span><span>Zul: ${brutto.toFixed(2)}‚Ç¨</span></div></div><div class="month-content ${mOpen?'open':''}">
                        <div class="month-details-bar">
                            <div class="detail-row row-nazu"><span>NaZu:</span><span><span class="val-h">${rNH}h</span> | <span class="val-eur">${nE.toFixed(2)}‚Ç¨</span></span></div>
                            <div class="detail-row row-fae"><span>FAE:</span><span><span class="val-count">${mG.fC}x</span> | <span class="val-eur">${mG.fE.toFixed(2)}‚Ç¨</span></span></div>
                            <div class="detail-row row-sazu"><span>SaZu:</span><span><span class="val-h">${mG.szH.toFixed(2)}h</span> | <span class="val-eur">${szE.toFixed(2)}‚Ç¨</span></span></div>
                            <div class="detail-row row-nacht-count"><span>N√§chte:</span><span class="val-count">${mG.nCounts}x</span></div>
                            <div class="detail-row row-sozu"><span>SoZu:</span><span><span class="val-h">${mG.soH.toFixed(2)}h</span> | <span class="val-eur">${soE.toFixed(2)}‚Ç¨</span></span></div>
                            <div class="detail-row row-fezu"><span>FeZu:</span><span><span class="val-h">${mG.ftH.toFixed(2)}h</span> | <span class="val-eur">${ftE.toFixed(2)}‚Ç¨</span></span></div>
                            <div class="detail-row row-4uhr"><span>4 Uhr:</span><span class="val-eur">${mG.bE.toFixed(2)}‚Ç¨</span></div>
                            <div class="detail-row row-brgb"><span>Spesen:</span><span class="val-eur">${mG.sp.toFixed(2)}‚Ç¨</span></div>
                        </div><div class="spesen-bar">Netto-Vorschau: ~ ${nV.toFixed(2)} ‚Ç¨</div>
                        <table>${mG.items.sort((a,b)=>new Date(b.d)-new Date(a.d)).map(r => {
                            const wd = wDaysShort[new Date(r.d).getDay()];
                            const isNight = r.d !== (r.d_end || r.d);
                            const isToday = r.d === todayStr;
                            const isFutureRow = r.d > todayStr;
                            let typeClass = 'type-dienst';
                            let stLower = r.status.toLowerCase();
                            if(stLower.includes('bereit')) typeClass = 'type-bereit';
                            else if(stLower.includes('dispo')) typeClass = 'type-dispo';
                            else if(stLower.includes('krank')) typeClass = 'type-krank';
                            else if(stLower.includes('urlaub')) typeClass = 'type-urlaub';
                            else if(stLower.includes('ruhe') || stLower.includes('schulung')) typeClass = 'type-ruhe';
                            const rowClass = (isToday ? 'row-today ' : '') + (isFutureRow ? 'is-future ' : '') + typeClass;
                            const hideIcons = ['urlaub', 'krank', 'ruhe', 'schulung', 'ruhe nach nacht', 'krank nach nacht'].includes(stLower);
                            const faeIcon = (r.tr && !hideIcons) ? 'üöó' : '';
                            const locIcon = (r.loc && !hideIcons) ? `üìç ${r.loc}` : '';
                            let displayStatus = r.status;
                            return `<tr id="row-${r.id}" class="${rowClass}"><td><b>${wd}, ${r.d.split('-').reverse().slice(0,2).join('.')}</b><br><small>${displayStatus}${r.isEdited ? ' <span class="is-edited-mark">‚úé</span>' : ''}</small></td><td>${r.s||'--'}-${r.e||'--'}${isNight ? ' (N)' : ''}<br><small>${r.h.toFixed(1)}h</small><div class="row-status-info"><span>${locIcon}</span><span>${faeIcon}</span></div></td><td class="action-btns"><button class="btn-mini btn-edit" onclick="edit(${r.id})">‚úé</button><button class="btn-mini btn-del" onclick="del(${r.id})">üóë</button></td></tr>`;
                        }).join('')}</table></div></div>`;
                if(isFocus) focusHtml += mHtml; else { otherHtml += mHtml; otherCount++; }
            });
            yearHtml += focusHtml;
            if(otherCount > 0) {
                const oOpen = openOthers.has(y);
                yearHtml += `<div class="month-header ${oOpen?'open':''}" style="background:#64748b; margin: 10px; border-radius: 8px;" onclick="toggleOthers('${y}')"><span>Weitere Monate (${otherCount})</span></div><div class="month-content ${oOpen?'open':''}">${otherHtml}</div>`;
            }
            yearHtml += `</div></div>`; cont.innerHTML += yearHtml;
        });
    }

    function toggleM(m) { openMonths.has(m)?openMonths.delete(m):openMonths.add(m); render(); }
    function toggleY(y) { openYears.has(y)?openYears.delete(y):openYears.add(y); render(); }
    function edit(id) { 
        const r=data.find(x=>x.id===id); if(!r) return;
        document.getElementById('edit-id').value=r.id; document.getElementById('d').value=r.d; 
        document.getElementById('s').value=r.s||''; document.getElementById('e').value=r.e||''; document.getElementById('ev').value=r.ev||''; document.getElementById('eb').value=r.eb||''; 
        document.getElementById('p1s').value=r.p1s||''; document.getElementById('pd1').value=r.pd1||0; document.getElementById('p2s').value=r.p2s||''; document.getElementById('pd2').value=r.pd2||0; 
        document.getElementById('loc').value=r.loc||'BHF'; document.getElementById('tr').checked=!!r.tr; document.getElementById('korrHin').value=r.korrHin||''; document.getElementById('korrRueck').value=r.korrRueck||''; 
        document.getElementById('extra_h').value=r.extra_h||'';
        document.getElementById('edit-id-view').style.display='block'; document.getElementById('btn-cancel-edit').style.display='flex'; toggleStatus(r.status.toLowerCase().replace(/ /g, '-')); window.scrollTo(0,0); 
    }
    function cancelEdit() { 
        document.getElementById('edit-id').value=''; document.getElementById('edit-id-view').style.display='none'; document.getElementById('btn-cancel-edit').style.display='none'; 
        ['s','e','p1s','p2s','ev','eb','korrHin','korrRueck','d_end','extra_h'].forEach(i=>document.getElementById(i).value=''); ['pd1','pd2'].forEach(i=>document.getElementById(i).value=0); 
        activeStatus='Dienst'; toggleStatus('dienst'); 
    }

    const initToday = new Date().toISOString().split('T')[0];
    const todayShift = data.find(r => r.d === initToday);
    if(todayShift) edit(todayShift.id); else { document.getElementById('d').value = initToday; autoDetectDay(); }
    render();

    function exportToGoogleCalendar() {
        let icsFile = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Lok-Zulagen-Rechner//DE','METHOD:PUBLISH','X-WR-CALNAME:Dienstplan','X-WR-TIMEZONE:Europe/Berlin'];
        const filterLimit = new Date(); filterLimit.setDate(filterLimit.getDate() - 7); filterLimit.setHours(0,0,0,0);
        data.filter(r => new Date(r.d) >= filterLimit).forEach(shift => {
            const statusFormatted = shift.status;
            const stL = shift.status.toLowerCase();
            const isTimedOff = ['Ruhe Nach Nacht', 'Krank Nach Nacht'].includes(statusFormatted);
            const isAllDay = (!shift.s || !shift.e || ['Urlaub', 'Krank', 'Ruhe', 'Schulung'].includes(statusFormatted)) && !isTimedOff;
            
            let icon = "üöÑ";
            if (stL.includes("urlaub")) icon = "üèñÔ∏è";
            else if (stL.includes("krank")) icon = "üöë";
            else if (stL.includes("ruhe")) icon = "üõåüèΩ";

            let summary, startStr, endStr;
            if (isAllDay) {
                summary = `${icon} ${statusFormatted} ${icon}`;
                const d1 = shift.d.replace(/-/g, '');
                let dEnd = new Date(shift.d); dEnd.setDate(dEnd.getDate() + 1);
                const d2 = dEnd.toISOString().split('T')[0].replace(/-/g, '');
                startStr = `DTSTART;VALUE=DATE:${d1}`; endStr = `DTEND;VALUE=DATE:${d2}`;
            } else {
                let label = "Dienst";
                if (stL.includes("dispo")) label = "Dispo";
                else if (stL.includes("schulung")) label = "Schulung";
                else if (stL.includes("bereit")) label = "Bereitschaft";
                
                const titleText = isTimedOff ? statusFormatted : `${label} ${shift.s} - ${shift.e}`;
                summary = `${icon} ${titleText} ${icon}`;
                const tStart = shift.d.replace(/-/g, '') + 'T' + shift.s.replace(':', '') + '00';
                const tEnd = (shift.d_end || shift.d).replace(/-/g, '') + 'T' + shift.e.replace(':', '') + '00';
                startStr = `DTSTART;TZID=Europe/Berlin:${tStart}`; endStr = `DTEND;TZID=Europe/Berlin:${tEnd}`;
            }
            icsFile.push('BEGIN:VEVENT');
            icsFile.push(`UID:shift_${shift.id}_${shift.d.replace(/-/g,'')}@lokrechner.local`);
            icsFile.push(`DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z`);
            icsFile.push(`SUMMARY:${summary}`);
            icsFile.push(startStr); icsFile.push(endStr);
            icsFile.push(`DESCRIPTION:Status: ${statusFormatted} | Dauer: ${shift.h.toFixed(2)}h`);
            icsFile.push('END:VEVENT');
        });
        icsFile.push('END:VCALENDAR');
        const blob = new Blob([icsFile.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Dienstplan_Sync_${new Date().toISOString().split('T')[0]}.ics`; link.click();
        showToast("iCal (V3.2.3) bereit!");
    }
</script>
</body>
</html>
