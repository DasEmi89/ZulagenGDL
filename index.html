<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #import-panel, #info-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; }
        .btn-sub.active { background: var(--success) !important; }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }
    </style>
</head>
<body>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="toggleInfo()">‚ÑπÔ∏è</span>
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0">Status 2026</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist (h)</small><br><strong id="h_sum">0.00</strong></div>
        <div><small>Saldo (h)</small><br><strong id="d_sum">0.00</strong></div>
        <div style="text-align:right"><small>Soll Rest (h)</small><br><strong id="s_offen">0.00</strong></div>
    </div>
    <div class="header-info-row" style="text-align: center; font-size: 0.8rem; margin-top: 10px;">
        <div id="extra-vac-summary">Zusatzurlaub: 0 Tage</div>
    </div>
    <div class="progress-bar"><div id="p_fill" class="progress-fill"></div></div>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Einstellungen</h2>
    <div class="grid">
        <div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div>
        <div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div>
    </div>
    <button onclick="exportList()" style="background:#0f172a;">üì• LISTE EXPORTIEREN</button>
    <button onclick="toggleImport()" style="background:#475569;">üì§ LISTE IMPORTIEREN</button>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN</button>
    <button onclick="toggleConfig()" style="background:#64748b;">ZUR√úCK</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Semikolon-Liste Import</h2>
    <p style="font-size: 0.7rem; color: #64748b; margin-bottom: 10px;">Format: Datum;Status;Beginn;Ende;Ort;FAE;P1S;P1E;P2S;P2E</p>
    <textarea id="import-area" style="width:100%; height:300px; font-family:monospace; font-size:0.7rem;" placeholder="2026-02-03;dienst;09:57;22:40;BRGB;1;;;;"></textarea>
    <button onclick="processListImport()" style="background:var(--success)">IMPORT STARTEN</button>
    <button onclick="toggleImport()" style="background:#64748b;">ABBRECHEN</button>
</div>

<div id="refresh-dialog">
    <div class="dialog-content">
        <h3>Neu berechnen</h3>
        <input type="date" id="refresh-date">
        <button onclick="recalculateFromDate()" style="background:var(--success)">START</button>
        <button onclick="closeRefreshDialog()">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <div id="btn-cancel-edit" style="display:none; text-align:right; color:var(--danger); font-weight:bold; cursor:pointer;" onclick="cancelEdit()">ABBRECHEN √ó</div>
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum</label><input type="date" id="d"></div><div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div></div>
    <div class="grid"><div><label>Beginn</label><input type="time" id="s"></div><div><label>Ende</label><input type="time" id="e"></div></div>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;"><input type="checkbox" id="tr" checked> <label>FAE Aktiv</label></div>
    <button onclick="add()" style="margin-top:0">Schicht speichern</button>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:5px; margin-top:10px;">
        <button class="btn-sub" onclick="toggleStatus('bereit')">Brd.</button>
        <button class="btn-sub" onclick="toggleStatus('urlaub')">Url.</button>
        <button class="btn-sub" onclick="toggleStatus('krank')">Krk.</button>
        <button class="btn-sub" onclick="toggleStatus('ruhe')">Ruhe</button>
    </div>
</div>

<div id="history"></div>

<script>
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d);
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let activeStatus = 'Dienst';

    function timeToDec(t) { if(!t || t === "") return null; let [h,m]=t.split(':').map(Number); return h + m/60; }

    // --- IMPORT LOGIK (10 Felder) ---
    function processListImport() {
        const text = document.getElementById('import-area').value.trim();
        if(!text) return;
        const lines = text.split('\n');
        let imported = 0;

        lines.forEach(line => {
            const c = line.split(';');
            if(c.length >= 2) {
                const dateStr = c[0].trim();
                if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return;

                let r = {
                    d: dateStr,
                    status: c[1].trim().charAt(0).toUpperCase() + c[1].trim().slice(1).toLowerCase(),
                    s: c[2] ? c[2].trim() : '',
                    e: c[3] ? c[3].trim() : '',
                    loc: c[4] ? c[4].trim() : 'BHF',
                    tr: c[5] === '1',
                    p1s: c[6] ? c[6].trim() : '',
                    p1e: c[7] ? c[7].trim() : '',
                    p2s: c[8] ? c[8].trim() : '',
                    p2e: c[9] ? c[9].trim() : '',
                    id: Date.now() + Math.random(),
                    ev: '', eb: ''
                };
                // Automatik f√ºr Bereitschafts-Spesen
                if(r.status === 'Bereit' && r.s) { r.ev = r.s; r.eb = r.e; }
                
                r = calculateShift(r);
                data.push(r);
                imported++;
            }
        });
        saveAndRender();
        toggleImport();
        alert(imported + " Schichten importiert.");
    }

    // --- EXPORT LOGIK ---
    function exportList() {
        let output = "";
        // Sortiert nach Datum aufsteigend f√ºr den Export
        const sorted = [...data].sort((a,b) => a.d.localeCompare(b.d));
        
        sorted.forEach(r => {
            const fields = [
                r.d,
                r.status.toLowerCase(),
                r.s || '',
                r.e || '',
                r.loc || 'BHF',
                r.tr ? '1' : '0',
                r.p1s || '',
                r.p1e || '',
                r.p2s || '',
                r.p2e || ''
            ];
            output += fields.join(';') + "\n";
        });

        navigator.clipboard.writeText(output).then(() => {
            alert("Liste im Semikolon-Format in die Zwischenablage kopiert!");
        });
    }

    function calculateShift(r) {
        let st = r.status.toLowerCase();
        r.h=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=0;
        
        if(['dienst','krank','bereit','dispo','schulung'].includes(st)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e);
            if(st === 'krank' && (t1 === null)) { r.h = config.gutschrift; return r; }
            if(t1===null || t2===null) return r;
            if(t2<=t1) t2+=24;

            // Pausen-Abzug
            let pauseTotal = 0;
            if(r.p1s && r.p1e) { 
                let ps = timeToDec(r.p1s), pe = timeToDec(r.p1e);
                if(pe > ps) pauseTotal += (pe - ps);
            }
            if(r.p2s && r.p2e) { 
                let ps = timeToDec(r.p2s), pe = timeToDec(r.p2e);
                if(pe > ps) pauseTotal += (pe - ps);
            }

            let n=0, sz=0, so=0, ft=0, w=0;
            for(let i=t1; i<t2; i+=(1/60)) {
                w+=(1/60);
                let curr=i%24, dt=new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                let isF=["2026-01-01","2026-05-01"].includes(dt.toISOString().split('T')[0]); // Vereinfacht f√ºr Beispiel
                let isO=dt.getDay()===0, isA=dt.getDay()===6;
                if(curr>=20 || curr<6) n+=(1/60);
                if(isO) so+=(1/60); else if(isA && curr>=13 && curr<20) sz+=(1/60);
            }
            r.h = Math.max(0, w - pauseTotal);
            r.nH=n; r.szH=sz; r.soH=so;
            r.bonus=((t1%24>=0 && t1%24<4) || (t2%24>0 && t2%24<=4)) ? config.bonus : 0;
            
            let abw = (r.loc === 'BRGB') ? (t2-t1 + 1.5) : (t2-t1 - 0.11);
            r.spesen = abw>=8 ? (abw>=24?config.v3:(abw>=14?config.v2:config.v1)) : 0;
            r.fae = r.tr ? config.fahrt : 0;
        } else if(st==='urlaub') { r.h=config.gutschrift; }
        return r;
    }

    function add() {
        let r = {
            d: document.getElementById('d').value,
            status: activeStatus,
            s: document.getElementById('s').value,
            e: document.getElementById('e').value,
            loc: document.getElementById('loc').value,
            tr: document.getElementById('tr').checked,
            id: document.getElementById('edit-id').value || Date.now()
        };
        if(!r.d) return;
        r = calculateShift(r);
        const idx = data.findIndex(x => x.id == r.id);
        if(idx > -1) data[idx] = r; else data.push(r);
        saveAndRender();
        cancelEdit();
    }

    function saveAndRender() {
        localStorage.setItem('shifts_p10', JSON.stringify(data));
        render();
    }

    function render() {
        const hist = document.getElementById('history'); hist.innerHTML = '';
        let tH=0, tN=0;
        const tree = {};
        data.forEach(r => {
            const m = r.d.substring(0,7);
            if(!tree[m]) tree[m] = { items: [], h:0, nH:0 };
            tree[m].items.push(r);
            if(r.d.startsWith("2026")) { tH += r.h; tN += r.nH; }
        });

        document.getElementById('h_sum').innerText=tH.toFixed(2);
        document.getElementById('p_fill').style.width = (tH/config.jsoll*100) + '%';
        document.getElementById('extra-vac-summary').innerText=`Zusatzurlaub: ${Math.floor(tN/19.2)} Tage`;

        Object.keys(tree).sort().reverse().forEach(m => {
            const open = openMonths.has(m);
            let html = `<div class="year-group"><div class="month-header" onclick="toggleM('${m}')">${m}</div><div class="month-content ${open?'open':''}"><table>`;
            tree[m].items.forEach(r => {
                html += `<tr><td>${r.d}<br><small>${r.status}</small></td><td>${r.s}-${r.e}<br><small>${r.h.toFixed(2)}h</small></td><td><button onclick="edit(${r.id})">‚úé</button></td></tr>`;
            });
            hist.innerHTML += html + `</table></div></div>`;
        });
    }

    function edit(id) {
        const r = data.find(x => x.id == id);
        document.getElementById('edit-id').value = r.id;
        document.getElementById('d').value = r.d;
        document.getElementById('s').value = r.s;
        document.getElementById('e').value = r.e;
        document.getElementById('loc').value = r.loc;
        document.getElementById('tr').checked = r.tr;
        document.getElementById('btn-cancel-edit').style.display='block';
    }

    function toggleStatus(st) { activeStatus = st.charAt(0).toUpperCase() + st.slice(1); }
    function toggleM(m) { openMonths.has(m)?openMonths.delete(m):openMonths.add(m); render(); }
    function toggleConfig() { const p=document.getElementById('config-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    function toggleImport() { const p=document.getElementById('import-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    function openRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'flex'; }
    function closeRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'none'; }
    function cancelEdit() { document.getElementById('edit-id').value=''; document.getElementById('btn-cancel-edit').style.display='none'; }
    function saveConfig() { localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render(); }
    function toggleInfo() { alert("V84 GitHub Edition\nImport/Export aktiv."); }
    function recalculateFromDate() {
        const sd = document.getElementById('refresh-date').value;
        data = data.map(r => r.d >= sd ? calculateShift(r) : r);
        saveAndRender(); closeRefreshDialog();
    }
    
    render();
</script>
</body>
</html>
