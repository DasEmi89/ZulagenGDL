    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datensicherung (Hermit App)</label>
        <button onclick="exportData()" style="background:#475569; margin-top:0; font-size:0.9rem;">ðŸ“¥ BACKUP KOPIEREN</button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">ðŸ“¤ IMPORT</button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN & SCHLIEáºžEN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Daten Importieren</h2>
    <p style="font-size: 0.8rem; color: #64748b;">FÃ¼ge deinen Backup-Text hier ein:</p>
    <textarea id="import-area" style="width:100%; height:300px; font-family:monospace; font-size:0.7rem; margin-bottom:15px;" placeholder='{"data":[...]}'></textarea>
    <button onclick="processImport()" style="background:var(--success)">DATEN VERARBEITEN</button>
    <button onclick="toggleImport()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="refresh-dialog" onclick="if(event.target===this) closeRefreshDialog()">
    <div class="dialog-content">
        <h3 style="margin-top:0">Tarif-Update</h3>
        <p style="font-size: 0.8rem; color: #64748b;">Ab welchem Datum sollen Schichten neu berechnet werden?</p>
        <input type="date" id="refresh-date" style="margin-bottom:15px;">
        <button onclick="recalculateFromDate()" style="background:var(--success)">NEU BERECHNEN</button>
        <button onclick="closeRefreshDialog()" style="background:#64748b; margin-top:8px;">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <div id="btn-cancel-edit" class="btn-close-edit" onclick="cancelEdit()">Ã—</div>
    <div id="edit-id-view" style="display:none; color:var(--warn); font-weight:bold; margin-bottom:10px; text-align:center;">âœŽ BEARBEITEN AKTIV</div>
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum</label><input type="date" id="d" onchange="autoDetectDay()"></div><div><label>Typ</label><div id="type-display" style="padding:12px; background:#f1f5f9; border-radius:10px; text-align:center; font-weight:bold; font-size:0.8rem;">WERKTAG</div></div></div>
    <div class="grid"><div><label>Beginn</label><input type="time" id="s"></div><div><label>Ende</label><input type="time" id="e"></div></div>
    
    <div id="bereitschaft-felder" class="bereitschaft-extra" style="display:none; background: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 10px; margin-bottom: 12px;">
        <label style="color:var(--warn); margin-bottom:8px; display:block;">Einsatz auswÃ¤rts (fÃ¼r Ausbleibezeit)</label>
        <div class="grid"><div><label>Von</label><input type="time" id="ev"></div><div><label>Bis</label><input type="time" id="eb"></div></div>
    </div>

    <div class="pause-box">
        <label>Pause 1 (Beginn & Dauer)</label>
        <div class="pause-row"><input type="time" id="p1s"><select id="pd1"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option><option value="45">45 Min</option><option value="60">60 Min</option></select></div>
        <label>Pause 2 (Beginn & Dauer)</label>
        <div class="pause-row"><input type="time" id="p2s"><select id="pd2"><option value="0">0 Min</option><option value="15">15 Min</option><option value="30">30 Min</option></select></div>
    </div>
    <div class="grid">
        <div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><label>Korr. Hin</label><input type="number" id="korrHin" placeholder="Min"></div>
            <div><label>Korr. RÃ¼ck</label><input type="number" id="korrRueck" placeholder="Min"></div>
        </div>
    </div>
    <div class="grid" style="align-items: center; justify-content: end;">
        <label style="display:flex; align-items:center; gap:8px; cursor: pointer;"><input type="checkbox" id="tr" checked style="width:22px; height:22px;"> FAE AKTIV</label>
    </div>
    <button id="main-btn" onclick="add()">Schicht speichern</button>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
        <button id="btn-bereit" class="btn-sub" onclick="toggleStatus('bereit')">Bereitschaft</button>
        <button id="btn-urlaub" class="btn-sub" onclick="toggleStatus('urlaub')">Urlaub</button>
        <button id="btn-krank" class="btn-sub" onclick="toggleStatus('krank')">Krank</button>
        <button id="btn-ruhe" class="btn-sub" onclick="toggleStatus('ruhe')">Ruhe</button>
    </div>
</div>

<div id="history"></div>

<script>
    const holidays = ["2026-01-01", "2026-03-08", "2026-04-03", "2026-04-06", "2026-05-01", "2026-05-14", "2026-05-25", "2026-10-03", "2026-12-25", "2026-12-26"];
    const monthNames = ["Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    const wDaysShort = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
    
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d && r.d.startsWith('2026'));
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let activeStatus = 'dienst';

    function showToast(txt) { const t=document.getElementById('toast'); t.innerText=txt; t.style.display='block'; setTimeout(()=>t.style.display='none', 2500); }

    async function exportData() {
        const str = JSON.stringify({ data, config, date: new Date().toLocaleString() });
        try { await navigator.clipboard.writeText(str); showToast("Backup in Zwischenablage!"); } catch (err) { alert("Kopieren fehlgeschlagen."); }
    }

    function toggleImport() {
        const p = document.getElementById('import-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    function processImport() {
        const raw = document.getElementById('import-area').value.trim();
        if(!raw) return;
        try {
            const p = JSON.parse(raw);
            if(p.data && Array.isArray(p.data)) {
                data = p.data;
                if(p.config) config = p.config;
                localStorage.setItem('shifts_p10', JSON.stringify(data));
                localStorage.setItem('shifts_cfg_v1', JSON.stringify(config));
                render();
                toggleImport();
                alert("Import von " + data.length + " EintrÃ¤gen erfolgreich!");
            } else {
                alert("Format ungÃ¼ltig: Das 'data' Array fehlt.");
            }
        } catch(e) {
            alert("Fehler beim Verarbeiten des JSON Codes. Bitte sicherstellen, dass alles kopiert wurde.");
        }
    }

    function timeToDec(t) { if(!t) return null; let [h,m]=t.split(':').map(Number); return h + m/60; }
    function openRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'flex'; document.getElementById('refresh-date').value = new Date().toISOString().split('T')[0]; }
    function closeRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'none'; }
    function recalculateFromDate() {
        const startD = document.getElementById('refresh-date').value; if(!startD) return;
        data = data.map(r => r.d >= startD ? calculateShift(r) : r);
        localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); closeRefreshDialog();
    }
    function toggleConfig() { 
        const p = document.getElementById('config-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block';
        if(p.style.display === 'block') ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => document.getElementById('cfg-'+k).value = config[k] || 0);
    }
    function saveConfig() {
        ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => { config[k] = parseFloat(document.getElementById('cfg-'+k).value) || 0; });
        localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render();
    }
    function autoDetectDay() {
        const dStr = document.getElementById('d').value; if(!dStr) return;
        const dt = new Date(dStr); let l = 'ðŸ¢ WERKTAG';
        if(holidays.includes(dStr)) l='ðŸš© FEIERTAG'; else if(dt.getDay()===0) l='â˜€ï¸ SONNTAG'; else if(dt.getDay()===6) l='ðŸ“… SAMSTAG';
        document.getElementById('type-display').innerText = l;
    }
    function toggleStatus(st) { activeStatus = activeStatus === st ? 'dienst' : st; ['bereit','ruhe','urlaub','krank'].forEach(b => document.getElementById('btn-'+b).classList.toggle('active', activeStatus === b)); document.getElementById('bereitschaft-felder').style.display = (activeStatus === 'bereit') ? 'block' : 'none'; }

    function calculateShift(r) {
        if(['dienst','krank','bereit'].includes(r.status)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e); if(t1===null || t2===null) return r;
            if(t2<=t1) t2+=24;
            let n=0, sz=0, so=0, ft=0, w=0;
            let p = []; if(r.p1s && r.pd1>0){ let s=timeToDec(r.p1s); if(s<t1)s+=24; p.push({s, e:s+r.pd1/60}); } if(r.p2s && r.pd2>0){ let s=timeToDec(r.p2s); if(s<t1)s+=24; p.push({s, e:s+r.pd2/60}); }
            for(let i=t1; i<t2; i+=0.25) {
                if(!p.some(pa => i>=pa.s && i<pa.e)) {
                    w+=0.25; let c=i%24, dt=new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                    let isF=holidays.includes(dt.toISOString().split('T')[0]), isO=dt.getDay()===0, isA=dt.getDay()===6;
                    if(c>=20 || c<6) n+=0.25; if(isF) ft+=0.25; else if(isO) so+=0.25; else if(isA && c>=13 && c<20) sz+=0.25;
                }
            }
            r.h=w; r.nH=n; r.szH=sz; r.soH=so; r.ftH=ft;
            r.bonus=(r.status!=='krank' && ((t1%24>=0 && t1%24<4) || (t2%24>0 && t2%24<=4))) ? config.bonus : 0;
            let abw = 0;
            if (r.tr) { 
                let wH = (r.korrHin && !isNaN(r.korrHin)) ? (parseFloat(r.korrHin)/60) : (config.wegeHin/60);
                let wR = (r.korrRueck && !isNaN(r.korrRueck)) ? (parseFloat(r.korrRueck)/60) : (config.wegeRueck/60);
                let diff = (r.status === 'bereit') ? (timeToDec(r.eb) - timeToDec(r.ev)) : (t2-t1);
                if(r.status === 'bereit' && (timeToDec(r.eb) <= timeToDec(r.ev))) diff += 24;
                abw = (r.loc === 'BRGB') ? (diff + wH + wR) : (diff - (7/60));
            }
            r.spesen = r.status==='krank'?0:(Math.max(0, abw)>=8 ? (abw>=24?config.v3:(abw>=14?config.v2:config.v1)) : 0);
            r.fae = r.tr ? config.fahrt : 0; r.faeCount = r.tr ? 1 : 0;
        } else if(r.status==='urlaub') { r.h=config.gutschrift; r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        else { r.h=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=r.faeCount=0; }
        return r;
    }

    function add() {
        const d=document.getElementById('d').value; if(!d) return;
        const id=document.getElementById('edit-id').value;
        let r={ d, status:activeStatus, id:id?parseInt(id):Date.now(), s:document.getElementById('s').value, e:document.getElementById('e').value, p1s:document.getElementById('p1s').value, pd1:parseInt(document.getElementById('pd1').value), p2s:document.getElementById('p2s').value, pd2:parseInt(document.getElementById('pd2').value), ev:document.getElementById('ev').value, eb:document.getElementById('eb').value, loc:document.getElementById('loc').value, tr:document.getElementById('tr').checked, korrHin:document.getElementById('korrHin').value, korrRueck:document.getElementById('korrRueck').value };
        r=calculateShift(r); if(id) data=data.filter(x=>x.id!==parseInt(id)); data.push(r); localStorage.setItem('shifts_p10', JSON.stringify(data)); cancelEdit(); render();
    }

    function del(id) { if(confirm('LÃ¶schen?')) { data=data.filter(r=>r.id!==id); localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); } }

    function render() {
        const cont = document.getElementById('history'); cont.innerHTML = '';
        let now=new Date(), tH=0, tV=0, tN=0; const g={};
        data.forEach(r => {
            const m=r.d.substring(0,7); tH+=r.h; if(r.status==='urlaub'&&new Date(r.d).getDay()%6!==0) tV++; tN+=r.nH;
            if(!g[m]) g[m]={items:[], h:0, nH:0, szH:0, soH:0, ftH:0, bE:0, sp:0, fE:0, fC:0, br:0};
            let mG=g[m]; mG.items.push(r); mG.h+=r.h; mG.nH+=r.nH; mG.szH+=r.szH; mG.soH+=r.soH; mG.ftH+=r.ftH; mG.bE+=r.bonus; mG.sp+=r.spesen; mG.fE+=r.fae; mG.fC+=(r.faeCount||0); if(r.loc==='BRGB') mG.br++;
        });
        let diffD=Math.max(1, Math.ceil((now-new Date(2026,0,1))/864e5)), sollH=(config.jsoll/365)*diffD;
        document.getElementById('h_sum').innerText=tH.toFixed(2); document.getElementById('d_sum').innerText=(tH-sollH).toFixed(2); document.getElementById('s_offen').innerText=(config.jsoll-tH).toFixed(2);
        
        const nSollH = (config.gutschrift * 60) / 5;
        document.getElementById('vac-summary').innerText=`Urlaub: ${tV}/${config.janspruch}`;
        document.getElementById('extra-vac-summary').innerText=`Zusatzurlaub: ${Math.floor(tN/nSollH)} Tage (${tN.toFixed(2)}/${nSollH.toFixed(2)}h)`;
        
        document.getElementById('p_fill').style.width=Math.min(100,(tH/config.jsoll*100))+"%"; 
        document.getElementById('p_text').innerText=`${(tH/config.jsoll*100).toFixed(1)}% von ${config.jsoll.toFixed(1)}h (2026)`;
        
        Object.keys(g).sort().reverse().forEach(m => {
            const mG=g[m], open=openMonths.has(m), [y, mo]=m.split('-'), nE=mG.nH*config.nacht, szE=mG.szH*config.samstag, soE=mG.soH*config.sonntag, ftE=mG.ftH*config.feiertag;
            const bruttoZulagen = nE + szE + soE + ftE + mG.bE;
            const nV = (nE + soE + ftE + mG.sp + mG.fE) + ((szE + mG.bE) * 0.65);
            
            cont.innerHTML += `<div class="year-group">
                <div class="month-header ${open?'open':''}" onclick="toggleM('${m}')">
                    <span>${monthNames[parseInt(mo)-1]} ${y} <b>(${mG.h.toFixed(1)}h)</b></span>
                    <div class="m-stats" ${open?'style="display:none"':''}>
                        <span>BRGB: ${mG.br}x</span>
                        <span>Zul: ${bruttoZulagen.toFixed(2)}â‚¬</span>
                    </div>
                </div>
                <div class="month-content ${open?'open':''}">
                    <div class="month-details-bar">
                        <div class="detail-row row-nazu"><span>NaZu:</span><span><span class="val-h">${mG.nH.toFixed(2)}h</span> | <span class="val-eur">${nE.toFixed(2)}â‚¬</span></span></div>
                        <div class="detail-row row-fae"><span>FAE:</span><span><span class="val-count">${mG.fC}x</span> | <span class="val-eur">${mG.fE.toFixed(2)}â‚¬</span></span></div>
                        <div class="detail-row row-sazu"><span>SaZu:</span><span><span class="val-h">${mG.szH.toFixed(2)}h</span> | <span class="val-eur">${szE.toFixed(2)}â‚¬</span></span></div>
                        <div class="detail-row row-brgb"><span>BRGB:</span><span class="val-count">${mG.br}x</span></div>
                        <div class="detail-row row-sozu"><span>SoZu:</span><span><span class="val-h">${mG.soH.toFixed(2)}h</span> | <span class="val-eur">${soE.toFixed(2)}â‚¬</span></span></div>
                        <div></div>
                        <div class="detail-row row-fezu"><span>FeZu:</span><span><span class="val-h">${mG.ftH.toFixed(2)}h</span> | <span class="val-eur">${ftE.toFixed(2)}â‚¬</span></span></div>
                        <div></div>
                        <div class="detail-row row-4uhr"><span>4 Uhr:</span><span class="val-eur">${mG.bE.toFixed(2)}â‚¬</span></div>
                    </div>
                    <div class="spesen-bar">Netto-Vorschau: ~ ${nV.toFixed(2)} â‚¬</div>
                    <table>${mG.items.sort((a,b)=>new Date(b.d)-new Date(a.d)).map(r => {
                        const wd = wDaysShort[new Date(r.d).getDay()];
                        const locText = (r.status === 'dienst' || r.status === 'bereit') ? ` (${r.loc})` : '';
                        return `<tr><td><b>${wd}, ${r.d.split('-').reverse().slice(0,2).join('.')}</b><br><small>${r.status}</small></td><td>${r.s||'--'}-${r.e||'--'}<br><small>${r.h.toFixed(1)}h${locText}</small></td><td class="action-btns"><button class="btn-mini btn-edit" onclick="edit(${r.id})">âœŽ</button><button class="btn-mini btn-del" onclick="del(${r.id})">ðŸ—‘</button></td></tr>`;
                    }).join('')}</table>
                </div>
            </div>`;
        });
    }
    function toggleM(m) { openMonths.has(m)?openMonths.delete(m):openMonths.add(m); render(); }
    function edit(id) { 
        const r=data.find(x=>x.id===id); if(!r) return;
        document.getElementById('edit-id').value=r.id; document.getElementById('d').value=r.d; 
        document.getElementById('s').value=r.s||''; document.getElementById('e').value=r.e||''; document.getElementById('ev').value=r.ev||''; document.getElementById('eb').value=r.eb||''; 
        document.getElementById('p1s').value=r.p1s||''; document.getElementById('pd1').value=r.pd1||0; document.getElementById('p2s').value=r.p2s||''; document.getElementById('pd2').value=r.pd2||0; 
        document.getElementById('loc').value=r.loc||'BHF'; document.getElementById('tr').checked=!!r.tr; document.getElementById('korrHin').value=r.korrHin||''; document.getElementById('korrRueck').value=r.korrRueck||''; 
        document.getElementById('edit-id-view').style.display='block'; document.getElementById('btn-cancel-edit').style.display='flex'; toggleStatus(r.status); window.scrollTo(0,0); 
    }
    function cancelEdit() { 
        document.getElementById('edit-id').value=''; document.getElementById('edit-id-view').style.display='none'; document.getElementById('btn-cancel-edit').style.display='none'; 
        ['s','e','p1s','p2s','ev','eb','korrHin','korrRueck'].forEach(i=>document.getElementById(i).value=''); ['pd1','pd2'].forEach(i=>document.getElementById(i).value=0); 
        activeStatus='dienst'; toggleStatus('dienst'); 
    }
    document.getElementById('d').value=new Date().toISOString().split('T')[0]; render();
</script>
</body>
</html>
