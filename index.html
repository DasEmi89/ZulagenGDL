<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #refresh-dialog, #import-panel, #tax-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        .pause-box { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .pause-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; border: 2px solid transparent; }
        .btn-sub.active { background: var(--success) !important; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white !important; transform: scale(1.02); }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; gap: 4px; }
        .month-header .m-stats { font-size: 0.75rem; color: #94a3b8; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .month-header.open::after { content: '‚ñ≤'; font-size: 0.5rem; margin-left: 3px; }
        .month-header:not(.open)::after { content: '‚ñº'; font-size: 0.5rem; margin-left: 3px; }
        .month-details-bar { background: #1a222f; color: #cbd5e0; padding: 12px 15px; font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; border-bottom: 2px solid #2d3748; }
        .detail-row { display: flex; justify-content: space-between; padding: 4px 6px; background: rgba(255,255,255,0.03); border-radius: 4px; border-left: 2px solid transparent; }
        .row-nazu { border-left-color: #38bdf8; }
        .row-fae { border-left-color: #fbbf24; }
        .row-sazu { border-left-color: #818cf8; }
        .row-brgb { border-left-color: #f87171; }
        .row-sozu { border-left-color: #4ade80; }
        .row-fezu { border-left-color: #f472b6; }
        .row-4uhr { border-left-color: #2dd4bf; }
        .row-nacht-count { border-left-color: #a78bfa; }
        .val-h { color: #38bdf8; font-weight: 500; }
        .val-eur { color: #4ade80; font-weight: 800; font-family: monospace; }
        .val-count { color: #fbbf24; font-weight: 800; }
        .spesen-bar { background: #111827; color: #4ade80; padding: 10px 15px; font-size: 0.9rem; border-bottom: 1px solid #4a5568; font-weight: bold; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; background: white; border-collapse: separate; }
        tr:nth-child(even) { background: #f8fafc; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        .type-dienst td:first-child { border-left: 5px solid var(--p) !important; }
        .type-bereit td:first-child, .type-dispo td:first-child { border-left: 5px solid var(--warn) !important; }
        .type-krank td:first-child { border-left: 5px solid var(--danger) !important; }
        .type-urlaub td:first-child { border-left: 5px solid var(--success) !important; }
        .type-ruhe td:first-child, .type-schulung td:first-child { border-left: 5px solid #64748b !important; }
        .row-today { background-color: rgba(37, 99, 235, 0.08) !important; }
        .is-future td:not(.action-btns) { opacity: 0.45; }
        .row-status-info { font-size: 0.65rem; color: #64748b; margin-top: 4px; display: flex; gap: 8px; }
        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-mini { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 35px; height: 35px; }
        .btn-edit { background: var(--p); }
        .btn-del { background: var(--danger); }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; }
        .btn-close-edit { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #e2e8f0; color: #64748b; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .header-info-row { font-size: 0.8rem; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); line-height: 1.4; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .year-header { background: #0f172a; color: #38bdf8; font-weight: 800; border-bottom: 2px solid #38bdf8; }
        .version-footer { text-align: center; font-size: 0.65rem; color: #94a3b8; margin-top: 40px; padding-bottom: 20px; line-height: 1.5; }
        .is-edited-mark { color: var(--warn); font-weight: bold; font-size: 1rem; margin-left: 4px; }
        .highlight-row { animation: highlightFade 2s ease-out; }
        @keyframes highlightFade { 0% { background-color: rgba(37, 99, 235, 0.2); } 100% { background-color: transparent; } }
    </style>
</head>
<body>

<div id="toast" class="toast">In Zwischenablage kopiert!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Status 2026</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist (bis heute)</small><br><strong id="h_sum">0.00</strong> <small>h</small></div>
        <div><small>Saldo Aktuell</small><br><strong id="d_sum">0.00</strong> <small>h</small></div>
        <div style="text-align:right"><small>Soll Restjahr</small><br><strong id="s_offen">0.00</strong> <small>h</small></div>
    </div>
    <div class="header-info-row">
        <div id="vac-summary">Urlaub: 0 / 36</div>
        <div id="extra-vac-summary" style="color: #93c5fd;">Zusatzurlaub: 0 Tage (0.00/96.00h)</div>
    </div>
    <div class="progress-bar"><div id="p_fill" class="progress-fill"></div></div>
    <div style="font-size: 0.6rem; margin-top: 5px; opacity: 0.8; text-align: center;" id="p_text">Berechne...</div>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Tarif-Einstellungen</h2>
    <div class="grid"><div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div><div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div></div>
    <div class="grid"><div><label>Samstag ‚Ç¨/h</label><input type="number" id="cfg-samstag" step="0.01"></div><div><label>Sonntag ‚Ç¨/h</label><input type="number" id="cfg-sonntag" step="0.01"></div></div>
    <div class="grid"><div><label>Feiertag ‚Ç¨/h</label><input type="number" id="cfg-feiertag" step="0.01"></div><div><label>4 Uhr Bonus ‚Ç¨</label><input type="number" id="cfg-bonus" step="0.01"></div></div>
    <div class="grid"><div><label>FAE ‚Ç¨/Tag</label><input type="number" id="cfg-fahrt" step="0.01"></div><div><label>Urlaub h/Tag</label><input type="number" id="cfg-gutschrift" step="0.01"></div></div>
    <hr>
    <button onclick="toggleTaxPanel()" style="background:#2563eb; margin-bottom: 15px;">üìä STEUER-EINSTELLUNGEN</button>
    <div class="grid"><div><label>Wege Hin</label><input type="number" id="cfg-wegeHin"></div><div><label>Wege R√ºck</label><input type="number" id="cfg-wegeRueck"></div></div>
    <div class="grid"><div><label>8h Spesen</label><input type="number" id="cfg-v1" step="0.01"></div><div><label>14h Spesen</label><input type="number" id="cfg-v2" step="0.01"></div></div>
    <div class="grid"><div><label>24h Spesen</label><input type="number" id="cfg-v3" step="0.01"></div><div><label>Urlaubsanspruch</label><input type="number" id="cfg-janspruch"></div></div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px;">Datensicherung</label>
        <button onclick="exportData()" style="background:#475569; margin-top:0; font-size:0.9rem;">üì• BACKUP KOPIEREN</button>
        <button onclick="exportJSONFile()" style="background:#2563eb; margin-top:8px; font-size:0.9rem;">üíæ ALS .JSON SPEICHERN</button>
        <button onclick="exportToGoogleCalendar()" style="background:#1a73e8; margin-top:8px; font-size:0.9rem;">üìÖ GOOGLE KALENDER SYNC (iCAL)</button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">üì§ IMPORT / DIENSTPLAN</button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN & SCHLIE·∫ûEN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="tax-panel">
    <h2 style="margin-top:0">Steuer-Parameter</h2>
    <div class="grid"><div><label>Brutto Monat</label><input type="number" id="tax-brutto" step="0.01"></div><div><label>Steuerklasse</label><input type="number" id="tax-stkl"></div></div>
    <div class="grid"><div><label>Kinderfreibetrag</label><input type="number" id="tax-kinder" step="0.5"></div><div><label>Zusatzbeitrag %</label><input type="number" id="tax-kk" step="0.01"></div></div>
    <div class="grid"><div><label>Netto Korrektur</label><input type="number" id="tax-corr" step="0.01" placeholder="Urlaubsgeld..."></div><div><label>Kirchensteuer %</label><input type="number" id="tax-kirche" step="1"></div></div>
    <div style="margin-bottom: 15px;"><label>Bundesland</label><select id="tax-bland"><option value="Berlin">Berlin</option><option value="Brandenburg">Brandenburg</option></select></div>
    <button onclick="saveTaxSettings()" style="background:var(--success)">√úBERNEHMEN</button>
    <button onclick="toggleTaxPanel()" style="background:#64748b; margin-top:10px">ZUR√úCK</button>
</div>

<div id="history"></div>

<div class="version-footer">
    Aktuelle Versionsnummer 3.3<br>
    Stand: 11.02.2026, 20:30 Uhr
</div>

<script>
    const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    const wDaysShort = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    let taxConfig = JSON.parse(localStorage.getItem('shifts_tax_cfg')) || {brutto: 3732.86, stkl: 4, kinder: 1, kk: 1.65, bland: 'Berlin', kirche: 0, corr: 0};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d);
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let openYears = new Set([new Date().getFullYear().toString()]);

    function getHolidays(year) {
        const fixed = [`${year}-01-01`, `${year}-03-08`, `${year}-05-01`, `${year}-10-03`, `${year}-12-25`, `${year}-12-26`];
        const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), n = Math.floor((h + l - 7 * m + 114) / 31), p = (h + l - 7 * m + 114) % 31;
        const osterSonntag = new Date(year, n - 1, p + 1);
        const calc = (offset) => { let d = new Date(osterSonntag); d.setDate(osterSonntag.getDate() + offset); return d.toISOString().split('T')[0]; };
        return [...fixed, calc(-2), calc(1), calc(39), calc(50)];
    }

    function calculateNet(brutto) {
        let rv = 0.093, alv = 0.013, kv = 0.073 + (taxConfig.kk/200), pv = 0.023; // Vereinfacht f√ºr Berlin/Kind
        let sv = brutto * (rv + alv + kv + pv);
        let tax = brutto * 0.16; // Approximation Lohnsteuer Stkl 4
        return brutto - sv - tax;
    }

    function render() {
        const cont = document.getElementById('history'); cont.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const tree = {};
        data.forEach(r => {
            const y = r.d.substring(0,4), m = r.d.substring(0,7);
            if(!tree[y]) tree[y] = { months: {} };
            if(!tree[y].months[m]) tree[y].months[m] = { items: [], h:0, nH:0, szH:0, soH:0, ftH:0, bE:0, sp:0, fE:0, nV:0, nBrutto: 0 };
            const mG = tree[y].months[m]; mG.items.push(r);
            if(r.d <= todayStr) {
                const nE = Math.round(r.nH) * config.nacht;
                const szE = r.szH * config.samstag;
                mG.h+=r.h; mG.nH+=r.nH; mG.szH+=r.szH; mG.soH+=r.soH; mG.ftH+=r.ftH; mG.bE+=r.bonus; mG.sp+=r.spesen; mG.fE+=r.fae;
                mG.nV += (nE + r.soH*config.sonntag + r.ftH*config.feiertag + r.spesen + r.fae) + ((szE + r.bonus) * 0.53);
                mG.nBrutto += (nE + szE + r.soH*config.sonntag + r.ftH*config.feiertag + r.bonus);
            }
        });

        const basisNet = calculateNet(taxConfig.brutto);

        Object.keys(tree).sort().reverse().forEach(y => {
            Object.keys(tree[y].months).sort().reverse().forEach(m => {
                const mG = tree[y].months[m], [yr, mo] = m.split('-');
                const mOpen = openMonths.has(m);
                let prevM = new Date(yr, mo-2, 1).toISOString().substring(0,7);
                let prevY = prevM.substring(0,4);
                let zulVormonat = (tree[prevY] && tree[prevY].months[prevM]) ? tree[prevY].months[prevM].nV : 0;
                const totalNet = basisNet + zulVormonat + (parseFloat(taxConfig.corr) || 0);

                cont.innerHTML += `<div class="year-group">
                    <div class="month-header ${mOpen?'open':''}" onclick="toggleM('${m}')">
                        <span>${monthNames[mo-1]} ${yr} <b>(${mG.h.toFixed(1)}h)</b></span>
                        <div class="m-stats"><span>Zulagen: ${mG.nBrutto.toFixed(2)}‚Ç¨</span></div>
                    </div>
                    <div class="month-content ${mOpen?'open':''}">
                        <div class="month-details-bar">
                            <div class="detail-row row-nazu"><span>NaZu Netto:</span><span>${(Math.round(mG.nH)*config.nacht).toFixed(2)}‚Ç¨</span></div>
                            <div class="detail-row row-sozu"><span>SoZu Netto:</span><span>${(mG.soH*config.sonntag).toFixed(2)}‚Ç¨</span></div>
                            <div class="detail-row row-sazu"><span>SaZu Brutto:</span><span>${(mG.szH*config.samstag).toFixed(2)}‚Ç¨</span></div>
                            <div class="detail-row row-brgb"><span>Spesen:</span><span>${mG.sp.toFixed(2)}‚Ç¨</span></div>
                        </div>
                        <div class="spesen-bar" style="color:#fff; background:#1e293b">Netto-Zulagen aktuell: ~ ${mG.nV.toFixed(2)} ‚Ç¨</div>
                        <div class="spesen-bar" style="background:#111827; border-top:1px solid #334155">Gesamt-Netto (Auszahlung): <span style="color:#4ade80">${totalNet.toFixed(2)} ‚Ç¨</span></div>
                    </div>
                </div>`;
            });
        });
    }

    function toggleM(m) { openMonths.has(m)?openMonths.delete(m):openMonths.add(m); render(); }
    function toggleTaxPanel() { const p = document.getElementById('tax-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function saveTaxSettings() {
        ['brutto','stkl','kinder','kk','kirche','corr'].forEach(k => taxConfig[k] = parseFloat(document.getElementById('tax-'+k).value) || 0);
        taxConfig.bland = document.getElementById('tax-bland').value;
        localStorage.setItem('shifts_tax_cfg', JSON.stringify(taxConfig)); toggleTaxPanel(); render();
    }
    function toggleConfig() { 
        const p = document.getElementById('config-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block';
        if(p.style.display === 'block') ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => document.getElementById('cfg-'+k).value = config[k] || 0);
    }
    function saveConfig() {
        ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift','v1','v2','v3','wegeHin','wegeRueck','janspruch'].forEach(k => config[k] = parseFloat(document.getElementById('cfg-'+k).value) || 0);
        localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render();
    }
    render();
</script>
</body>
</html>
