<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; position: relative; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
        #config-panel, #refresh-dialog, #import-panel, #info-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        #refresh-dialog { background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .dialog-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; color: var(--text); }
        .pause-box { background: #f1f5f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .pause-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; transition: transform 0.1s; }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; cursor: pointer; }
        .btn-sub.active { background: var(--success) !important; }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; font-size: 0.95rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; background: white; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .action-btns { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-mini { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.7rem; font-weight: bold; width: 35px; height: 35px; }
        .btn-edit { background: var(--p); }
        .btn-del { background: var(--danger); }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="toast" class="toast">Aktion erfolgreich!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="toggleInfo()">‚ÑπÔ∏è</span>
        <span class="icon-btn" onclick="openRefreshDialog()">üîÑ</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Status 2026</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
        <div><small>Ist (bis heute)</small><br><strong id="h_sum">0.00</strong> <small>h</small></div>
        <div><small>Saldo Aktuell</small><br><strong id="d_sum">0.00</strong> <small>h</small></div>
        <div style="text-align:right"><small>Soll Restjahr</small><br><strong id="s_offen">0.00</strong> <small>h</small></div>
    </div>
</div>

<div id="config-panel">
    <h2 style="margin-top:0">Tarif-Einstellungen</h2>
    <div class="grid"><div><label>Jahressoll h</label><input type="number" id="cfg-jsoll"></div><div><label>Nacht ‚Ç¨/h</label><input type="number" id="cfg-nacht" step="0.01"></div></div>
    <div class="grid"><div><label>Samstag ‚Ç¨/h</label><input type="number" id="cfg-samstag" step="0.01"></div><div><label>Sonntag ‚Ç¨/h</label><input type="number" id="cfg-sonntag" step="0.01"></div></div>
    <div class="grid"><div><label>Feiertag ‚Ç¨/h</label><input type="number" id="cfg-feiertag" step="0.01"></div><div><label>4 Uhr Bonus ‚Ç¨</label><input type="number" id="cfg-bonus" step="0.01"></div></div>
    <div class="grid"><div><label>FAE ‚Ç¨/Tag</label><input type="number" id="cfg-fahrt" step="0.01"></div><div><label>Urlaub h/Tag</label><input type="number" id="cfg-gutschrift" step="0.01"></div></div>
    <hr>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--p);">Datensicherung</label>
        <button onclick="exportSemicolonList()" style="background:#0f172a; font-size:0.9rem;">üì§ LISTE EXPORTIEREN (;) </button>
        <button onclick="toggleImport()" style="background:#475569; margin-top:8px; font-size:0.9rem;">üì• LISTE IMPORTIEREN (;) </button>
    </div>
    <button onclick="saveConfig()" style="background:var(--success)">SPEICHERN</button>
    <button onclick="toggleConfig()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="import-panel">
    <h2 style="margin-top:0">Daten importieren</h2>
    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">Format: Datum;Status;Beginn;Ende;Ort;FAE;P1Start;P1Ende;P2Start;P2Ende</p>
    <textarea id="import-area" style="width:100%; height:250px; font-family:monospace; font-size:0.7rem; margin-bottom:15px;" placeholder="2026-02-03;dienst;09:57;22:40;BRGB;1;;;;"></textarea>
    <button onclick="processImport()" style="background:var(--success)">IMPORT STARTEN</button>
    <button onclick="toggleImport()" style="background:#64748b; margin-top:10px">ABBRECHEN</button>
</div>

<div id="refresh-dialog">
    <div class="dialog-content">
        <h3>Tarif-Update</h3>
        <input type="date" id="refresh-date">
        <button onclick="recalculateFromDate()" style="background:var(--success)">NEU BERECHNEN</button>
        <button onclick="closeRefreshDialog()">ABBRECHEN</button>
    </div>
</div>

<div class="card" id="input-card">
    <input type="hidden" id="edit-id">
    <div class="grid"><div><label>Datum</label><input type="date" id="d"></div><div><label>Typ</label><select id="st_select" onchange="toggleStatus(this.value)"><option value="dienst">Dienst</option><option value="bereit">Bereit</option><option value="dispo">Dispo</option><option value="urlaub">Urlaub</option><option value="krank">Krank</option><option value="ruhe">Ruhe</option></select></div></div>
    <div id="time-fields" class="grid"><div><label>Beginn</label><input type="time" id="s"></div><div><label>Ende</label><input type="time" id="e"></div></div>
    <div class="grid"><div><label>Ort</label><select id="loc"><option value="BHF">BHF</option><option value="BRGB">BRGB</option></select></div><div style="padding-top:25px;"><label><input type="checkbox" id="tr" checked> FAE</label></div></div>
    <button onclick="add()">Speichern</button>
</div>

<div id="history"></div>

<script>
    let config = JSON.parse(localStorage.getItem('shifts_cfg_v1')) || {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0, v1: 6.0, v2: 9.0, v3: 13.0, wegeHin: 45, wegeRueck: 45, janspruch: 36};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]').filter(r => r.d);
    let openMonths = new Set([new Date().toISOString().substring(0,7)]);
    let activeStatus = 'dienst';

    function timeToDec(t) { if(!t || t.trim() === "") return null; let [h,m]=t.split(':').map(Number); return h + m/60; }
    
    function diffMinutes(start, end) {
        let s = timeToDec(start), e = timeToDec(end);
        if(s === null || e === null) return 0;
        if(e <= s) e += 24;
        return Math.round((e - s) * 60);
    }

    function processImport() {
        const raw = document.getElementById('import-area').value.trim();
        if(!raw) return alert("Feld ist leer!");
        const lines = raw.split('\n');
        let imported = 0, errors = 0;

        lines.forEach((line, idx) => {
            const c = line.split(';');
            if(c.length >= 2 && /^\d{4}-\d{2}-\d{2}$/.test(c[0].trim())) {
                const d = c[0].trim();
                const st = c[1].trim().toLowerCase();
                const existingIdx = data.findIndex(x => x.d === d);
                
                let r = {
                    d: d, status: st, id: existingIdx !== -1 ? data[existingIdx].id : Date.now() + Math.random(),
                    s: c[2]||"", e: c[3]||"", loc: c[4]||"BHF", tr: c[5]==="1",
                    p1s: c[6]||"", pd1: (c[6] && c[7]) ? diffMinutes(c[6], c[7]) : 0,
                    p2s: c[8]||"", pd2: (c[8] && c[9]) ? diffMinutes(c[8], c[9]) : 0,
                    ev: "", eb: "", korrHin: "", korrRueck: ""
                };
                if(st === "bereit" && r.s) { r.ev = r.s; r.eb = r.e; }
                r = calculateShift(r);
                if(existingIdx !== -1) data[existingIdx] = r; else data.push(r);
                imported++;
            } else if(line.trim() !== "") { errors++; }
        });

        localStorage.setItem('shifts_p10', JSON.stringify(data));
        render(); toggleImport();
        alert(imported + " Schichten importiert." + (errors > 0 ? ` (${errors} Zeilen √ºbersprungen)` : ""));
    }

    function calculateShift(r) {
        let st = r.status.toLowerCase();
        r.h=r.nH=r.szH=r.soH=r.ftH=r.bonus=r.spesen=r.fae=0;
        if(['dienst','krank','bereit','dispo'].includes(st)) {
            let t1=timeToDec(r.s), t2=timeToDec(r.e);
            if(st === 'krank' && t1 === null) { r.h = config.gutschrift; return r; }
            if(t1 === null || t2 === null) return r;
            if(t2 <= t1) t2 += 24;
            let n=0, sz=0, so=0, w=0;
            let pauseDec = (r.pd1 + r.pd2) / 60;
            for(let i=t1; i<t2; i+=(1/60)) {
                w+=(1/60); let c=i%24;
                if(c>=20 || c<6) n+=(1/60);
                let dt = new Date(r.d); if(i>=24) dt.setDate(dt.getDate()+1);
                if(dt.getDay()===0) so+=(1/60); else if(dt.getDay()===6 && c>=13 && c<20) sz+=(1/60);
            }
            r.h = Math.max(0, w - pauseDec); r.nH = n; r.szH = sz; r.soH = so;
            r.bonus = ((t1%24>=0 && t1%24<4) || (t2%24>0 && t2%24<=4)) ? config.bonus : 0;
            let abw = (r.loc === 'BRGB') ? (t2-t1 + 1.5) : (t2-t1 - 0.1);
            r.spesen = abw>=8 ? (abw>=24?config.v3:(abw>=14?config.v2:config.v1)) : 0;
            r.fae = r.tr ? config.fahrt : 0;
        } else if(st === 'urlaub') { r.h = config.gutschrift; }
        return r;
    }

    function render() {
        const hist = document.getElementById('history'); hist.innerHTML = '';
        const sorted = [...data].sort((a,b) => b.d.localeCompare(a.d));
        let tH = 0;
        sorted.forEach(r => {
            tH += r.h;
            hist.innerHTML += `<div class="card"><b>${r.d} (${r.status})</b><br>${r.s||'--'}-${r.e||'--'} | ${r.h.toFixed(2)}h<div class="action-btns"><button class="btn-mini btn-del" onclick="del(${r.id})">üóë</button></div></div>`;
        });
        document.getElementById('h_sum').innerText = tH.toFixed(2);
    }

    function add() {
        let r = { d: document.getElementById('d').value, status: activeStatus, s: document.getElementById('s').value, e: document.getElementById('e').value, loc: document.getElementById('loc').value, tr: document.getElementById('tr').checked, id: Date.now(), pd1:0, pd2:0 };
        if(!r.d) return;
        r = calculateShift(r); data.push(r);
        localStorage.setItem('shifts_p10', JSON.stringify(data)); render();
    }

    function del(id) { data = data.filter(x => x.id != id); localStorage.setItem('shifts_p10', JSON.stringify(data)); render(); }
    function toggleImport() { const p = document.getElementById('import-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    function toggleConfig() { const p = document.getElementById('config-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    function toggleStatus(val) { activeStatus = val; }
    function openRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'flex'; }
    function closeRefreshDialog() { document.getElementById('refresh-dialog').style.display = 'none'; }
    function saveConfig() { ['jsoll','nacht','samstag','sonntag','feiertag','bonus','fahrt','gutschrift'].forEach(k => { config[k] = parseFloat(document.getElementById('cfg-'+k).value) || 0; }); localStorage.setItem('shifts_cfg_v1', JSON.stringify(config)); toggleConfig(); render(); }

    render();
</script>
</body>
</html>
