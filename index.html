<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Lok-Zulagen Rechner V84 (Standalone)</title>
    <style>
        :root { --p: #2563eb; --bg: #f8fafc; --text: #1e293b; --warn: #f59e0b; --danger: #ef4444; --success: #16a34a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 15px 30px; }
        .total-summary { background: var(--p); color: white; margin: -15px -15px 20px -15px; padding: calc(40px + env(safe-area-inset-top)) 20px 25px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; color: #64748b; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        #config-panel, #import-panel, #info-panel { display: none; position: fixed; inset: 0; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-sub { background: #64748b; padding: 10px; font-size: 0.8rem; border-radius: 10px; color: white; border: none; }
        .year-group { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .month-header { background: #1e293b; color: white; padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; }
        .month-content { display: none; }
        .month-content.open { display: block; }
        table { width: 100%; border-spacing: 0; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .top-icons { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; background: rgba(255,255,255,0.2); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; z-index: 9999; display: none; }
    </style>
</head>
<body>

<div id="toast" class="toast">Aktion erfolgreich!</div>

<div class="total-summary">
    <div class="top-icons">
        <span class="icon-btn" onclick="toggleInfo()">‚ÑπÔ∏è</span>
        <span class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</span>
    </div>
    <h3 style="margin:0" id="header-year">Lok-Rechner V84</h3>
    <div style="display:flex; justify-content: space-between; margin-top:15px;">
        <div><small>Gesamtstunden</small><br><strong id="h_sum">0.00</strong> h</div>
        <div id="extra-vac-summary">Zusatzurlaub: 0 Tage</div>
    </div>
</div>

<div id="import-panel">
    <h2>Daten importieren</h2>
    <p>Format: Datum;Status;Beginn;Ende;Ort;FAE;P1S;P1E;P2S;P2E</p>
    <textarea id="import-area" style="height:200px;" placeholder="2026-02-03;dienst;09:57;22:40;BRGB;1;;;;"></textarea>
    <button onclick="processImport()" style="background:var(--success)">IMPORT STARTEN</button>
    <button onclick="toggleImport()" style="background:#64748b">ABBRECHEN</button>
</div>

<div id="config-panel">
    <h2>Einstellungen</h2>
    <button onclick="toggleImport()" style="background:#475569">üì• LISTE IMPORTIEREN</button>
    <button onclick="localStorage.clear(); location.reload();" style="background:var(--danger)">‚ö†Ô∏è ALLE DATEN L√ñSCHEN</button>
    <button onclick="toggleConfig()">SCHLIE·∫ûEN</button>
</div>

<div class="card">
    <button onclick="toggleImport()">Schnell-Import √∂ffnen</button>
</div>

<div id="history"></div>

<script>
    // --- DATEN & KONFIG ---
    let config = {jsoll: 2088, nacht: 3.72, samstag: 0.64, sonntag: 6.29, feiertag: 6.87, bonus: 7.91, fahrt: 6.65, gutschrift: 8.0};
    let data = JSON.parse(localStorage.getItem('shifts_p10') || '[]');

    function showToast(txt) { 
        const t=document.getElementById('toast'); 
        t.innerText=txt; t.style.display='block'; 
        setTimeout(()=>t.style.display='none', 2000); 
    }

    function timeToDec(t) { 
        if(!t || t.trim() === "") return null; 
        let [h,m]=t.split(':').map(Number); 
        return h + m/60; 
    }

    function diffMinutes(s, e) {
        if(!s || !e) return 0;
        let t1 = timeToDec(s), t2 = timeToDec(e);
        if(t2 <= t1) t2 += 24;
        return (t2 - t1) * 60;
    }

    // --- IMPORT LOGIK (GITHUB READY) ---
    function processImport() {
        const raw = document.getElementById('import-area').value.trim();
        if(!raw) return;
        
        const lines = raw.split('\n');
        let count = 0;

        lines.forEach(line => {
            const c = line.split(';');
            if(c.length < 2) return;

            const d = c[0].trim();
            const st = c[1].trim().charAt(0).toUpperCase() + c[1].trim().slice(1).toLowerCase();
            
            let r = {
                d: d, status: st, id: Date.now() + Math.random(),
                s: c[2]||"", e: c[3]||"", loc: c[4]||"BHF", tr: c[5]==="1",
                p1s: c[6]||"", pd1: (c[6] && c[7]) ? diffMinutes(c[6], c[7]) : 0,
                p2s: c[8]||"", pd2: (c[8] && c[9]) ? diffMinutes(c[8], c[9]) : 0
            };
            
            r = calculateShift(r);
            data.push(r);
            count++;
        });

        localStorage.setItem('shifts_p10', JSON.stringify(data));
        render();
        toggleImport();
        showToast(count + " Schichten importiert");
        document.getElementById('import-area').value = "";
    }

    // --- BERECHNUNG ---
    function calculateShift(r) {
        const status = r.status.toLowerCase();
        r.h = 0; r.nH = 0; r.totalZulage = 0;

        if(status === 'dienst' || status === 'dispo' || status === 'bereit') {
            let t1 = timeToDec(r.s), t2 = timeToDec(r.e);
            if(t1 === null || t2 === null) return r;
            if(t2 <= t1) t2 += 24;

            let work = 0, night = 0;
            let pause = (r.pd1 || 0) + (r.pd2 || 0);

            for(let i = t1; i < t2; i += (1/60)) {
                let currentH = i % 24;
                work += (1/60);
                // Nacht 20-06 Uhr
                if(currentH >= 20 || currentH < 6) night += (1/60);
            }
            
            r.h = Math.max(0, work - (pause/60));
            r.nH = night;
            
            // 4-Uhr-Bonus (Beginn ODER Ende zw. 0-4)
            if((t1 % 24 >= 0 && t1 % 24 < 4) || (t2 % 24 > 0 && t2 % 24 <= 4)) {
                r.totalZulage += config.bonus;
            }
        } else if (status === 'urlaub') {
            r.h = config.gutschrift;
        }
        return r;
    }

    // --- UI ---
    function render() {
        const cont = document.getElementById('history');
        cont.innerHTML = '';
        let totalH = 0;

        // Nach Datum sortieren
        data.sort((a,b) => b.d.localeCompare(a.d));

        data.forEach(r => {
            totalH += r.h;
            const div = document.createElement('div');
            div.className = 'card';
            div.style.margin = "10px";
            div.innerHTML = `<b>${r.d} - ${r.status}</b><br><small>${r.s || '--'}:${r.e || '--'} Uhr | ${r.h.toFixed(2)}h</small>`;
            cont.appendChild(div);
        });

        document.getElementById('h_sum').innerText = totalH.toFixed(2);
    }

    function toggleImport() { 
        const p = document.getElementById('import-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }
    function toggleConfig() {
        const p = document.getElementById('config-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    render();
</script>

</body>
</html>
